# 六十四卦マッピング改善計画v5（最終版）

## 4回のCodexディベートから得た教訓

### 一貫して指摘された根本問題
> **「文章から誰が読んでも同じ結論に到達する判定手順」が欠落している**

v2-v4の全てで、形容詞・概念・キーワードによる定義は「判定者の解釈に依存」するため失敗すると指摘された。

### Codexが認めた正しい方向性
1. 64クラス直接分類の廃止 → 階層分解
2. unknown（真ラベル）とabstain（モデル棄却）の分離
3. 二重アノテーション + 調停
4. 外部ゴールドセットでの評価

### Codexが一貫して否定した設計
1. キーワード列挙による定義
2. 形容詞軸（動静/強弱/明暗）による定義
3. 対立ペア判別規則による後付け補正
4. 文章構造（before/transformation）への依存

## v5の設計原則

> **操作的判定手順の完成を最優先**
> 「Yes/Noで答えられる質問」の連鎖で八卦を決定
> 文分割を前提とし、内部/外部要因を別々に判定

## Step 1: 操作的質問による八卦判定

### 1.1 判定質問（Yes/Noで回答可能）

**Q1: 時制（Temporal）**
- 「変化・行動が既に発生している（進行形/完了形）か？」
- Yes: 動的 / No: 静的（計画段階、検討中、待機中）

**Q2: 主体性（Agency）**
- 「当事者（自社/対象主体）が主導しているか？（外部から強制されていないか）」
- Yes: 能動 / No: 受動（強制、対応、追随）

**Q3: 確定性（Certainty）**
- 「結果または次の行動が確定しているか？（仮説・検討ではないか）」
- Yes: 確定 / No: 未確定（仮説、選択肢、不明）

**Q4: 規模（Scale）** ※3軸では不足のため追加
- 「変化・行動の規模が大きいか？（全社的、業界全体、長期的）」
- Yes: 大規模 / No: 小規模（部分的、短期的、局所的）

### 1.2 八卦の判定マトリクス

| Q1時制 | Q2主体 | Q3確定 | Q4規模 | 八卦 | ビジネス解釈 |
|--------|--------|--------|--------|------|--------------|
| Yes動的 | Yes能動 | Yes確定 | Yes大規模 | 乾 | 大規模な攻勢・拡大を実行中 |
| Yes動的 | Yes能動 | Yes確定 | No小規模 | 離 | 明確な施策を主導的に実行 |
| Yes動的 | Yes能動 | No未確定 | - | 震 | 主導的だが結果不透明な動き |
| Yes動的 | No受動 | Yes確定 | - | 坎 | 外部変化への確定的対応 |
| Yes動的 | No受動 | No未確定 | - | 巽 | 外部変化に徐々に適応中 |
| No静的 | Yes能動 | - | Yes大規模 | 艮 | 大きな判断で意図的に停止 |
| No静的 | Yes能動 | - | No小規模 | 兌 | 協調・交流の姿勢で待機 |
| No静的 | No受動 | - | - | 坤 | 完全に受動的な待機状態 |

### 1.3 判定フロー（決定木）

```
Q1: 変化・行動が既に発生しているか？
├─ Yes（動的）
│   └─ Q2: 当事者が主導しているか？
│       ├─ Yes（能動）
│       │   └─ Q3: 結果が確定しているか？
│       │       ├─ Yes → Q4で乾/離を判別
│       │       └─ No → 震
│       └─ No（受動）
│           └─ Q3: 結果が確定しているか？
│               ├─ Yes → 坎
│               └─ No → 巽
└─ No（静的）
    └─ Q2: 当事者が主導しているか？
        ├─ Yes（能動）
        │   └─ Q4: 規模が大きいか？
        │       ├─ Yes → 艮
        │       └─ No → 兌
        └─ No → 坤
```

### 1.4 判定優先規則

1. **事実 > 推量**: 「実行した」>「検討中」>「計画している」
2. **明示 > 省略**: 主語が明示されている文を優先
3. **単一 > 複合**: 複数要因は分割して別々に判定
4. **直近 > 過去**: 最新の状態を優先

## Step 2: 文分割による上卦/下卦判定

### 2.1 文分割手順

```
入力: before/transformation/outcomeテキスト
    ↓
[Step A] 文単位に分割
    ↓
[Step B] 各文を「内部要因」「外部要因」「その他」に分類
    ↓
[Step C] 内部要因文 → 下卦判定（Q1-Q4適用）
[Step D] 外部要因文 → 上卦判定（Q1-Q4適用）
    ↓
出力: (下卦, 上卦) → 64卦に合成
```

### 2.2 内部/外部の分類基準

| 分類 | 主語例 | キュー |
|------|--------|--------|
| 内部要因 | 自社、当社、我々、組織、経営陣 | 内部の状態、資源、能力、文化 |
| 外部要因 | 市場、競合、顧客、規制、技術 | 環境変化、外部圧力、機会 |
| その他 | 主語不明、一般論 | → 無視またはunknown |

### 2.3 分割できない場合

- **単一文に両方含む**: 原因-結果で分解（例: 「競合が値下げしたので当社も対応」→ 外部: 競合値下げ / 内部: 対応）
- **主語省略**: 文脈から推定、推定不能ならunknown
- **完全に混在**: unknown_tie

## Step 3: 段階（stage）の判定

### 3.1 3段階定義

| 段階 | 判定質問 | 判定基準 |
|------|----------|----------|
| early | 「実行前か？」 | 計画中、検討中、準備中、情報収集中 |
| mid | 「実行中か？」 | 展開中、転換中、岐路、試行錯誤中 |
| late | 「実行後か？」 | 完了、成功、失敗、結果確定、移行 |

### 3.2 判定フロー

```
outcomeテキストを読む
Q: 結果が記述されているか？
├─ Yes → late
└─ No
    Q: 実行中の記述があるか？
    ├─ Yes → mid
    └─ No → early
```

## Step 4: unknown/abstainの厳密設計

### 4.1 unknown（真ラベル）の3種類

| 種別 | 適用条件 | 判定例 |
|------|----------|--------|
| unknown_missing | Q1-Q4のうち2つ以上が回答不能 | 「状況が変わった」（詳細なし） |
| unknown_tie | 決定木で複数の八卦が同点 | 対立ペアが両方該当 |
| unknown_outofscope | ビジネス変化の記述がない | 一般的な説明文 |

### 4.2 abstain（モデル棄却）

- **条件**: 信頼度スコア < θ（検証セットで校正）
- **指標**: カバレッジ90%時の精度で評価
- **出力**: abstain_reason（どの質問で不確実だったか）

## Step 5: 評価指標の設計

### 5.1 必須指標一覧

| 指標 | 定義 | 目標 |
|------|------|------|
| 上卦Top-1精度 | 上卦の正解一致率 | ≥ 60% |
| 下卦Top-1精度 | 下卦の正解一致率 | ≥ 60% |
| 候補再現率@k=3 | 候補9個に正解が含まれる率 | ≥ 80% |
| **MRR** | 正解の平均逆順位 | ≥ 0.5 |
| **90%カバレッジ精度** | abstain10%時の精度 | ≥ 70% |
| 段階Top-1精度 | early/mid/lateの一致率 | ≥ 65% |
| **ECE** | 信頼度校正誤差 | ≤ 0.15 |

### 5.2 評価プロトコル

1. ゴールドセットを訓練/検証/テストに分割
2. 検証セットでθ（abstain閾値）を決定
3. テストセットで最終精度を報告
4. 信頼度校正（ECE）を測定し、必要なら温度スケーリング

## Step 6: アノテーション設計（現実的工数）

### 6.1 パイロット: 100件 × 2ラウンド

| ラウンド | 目的 | 工数 |
|----------|------|------|
| ラウンド1 | 初期ガイドライン検証 | 30h |
| 不一致分析・修正 | 判定規則の追加・修正 | 10h |
| ラウンド2 | 修正後の検証 | 30h |
| **小計** | | **70h** |

**合格基準**: 上卦κ ≥ 0.50、下卦κ ≥ 0.50、段階κ ≥ 0.55

### 6.2 ゴールドセット: 400件（二重+調停）

| 工程 | 内容 | 工数 |
|------|------|------|
| サンプリング | 難例優先層化抽出 | 4h |
| アノテーション | 2名 × 400件 | 64h |
| 調停 | 不一致解決（推定25%） | 20h |
| QA | 品質検証 | 8h |
| **小計** | | **96h** |

### 6.3 総工数

| フェーズ | 工数 |
|----------|------|
| Step 1-4: 定義・手順設計 | 24h |
| Step 6.1: パイロット2ラウンド | 70h |
| Step 6.2: ゴールドセット | 96h |
| Step 5: 分類器構築・評価 | 32h |
| バッファ（20%） | 44h |
| **総計** | **266h** |

## フォールバック戦略

| 条件 | 対応 |
|------|------|
| パイロット1でκ < 0.4 | Q4を廃止して3質問に簡素化 |
| パイロット2でκ < 0.5 | 八卦を4グループに統合（乾震/坎巽/離兌/艮坤） |
| 候補再現率@k=3 < 70% | k=5に拡大、階層分解を諦め64直接分類に戻る |
| 90%カバレッジ精度 < 60% | abstain閾値を上げてカバレッジ80%で運用 |
| 全体破綻 | 八卦レベル（8クラス）に撤退 |

## v4からの主な変更

| 項目 | v4 | v5 |
|------|-----|-----|
| 八卦定義 | 3軸（形容詞） | 4質問（操作的Yes/No） |
| 判定手順 | 軸組み合わせ | 決定木フロー |
| 対立ペア規則 | あり（後付け） | なし（決定木で解決） |
| 文分割 | 主語判定 | 明示的分割手順 |
| パイロット | 1ラウンド | 2ラウンド（改訂ループ） |
| 評価指標 | recall@k中心 | recall@k + MRR + ECE + 90%カバレッジ |
| 工数 | 154h | 266h（バッファ込み） |

## 成功の定義

1. **アノテーター間一致度**: 上卦/下卦κ ≥ 0.50、段階κ ≥ 0.55
2. **候補再現率@k=3**: ≥ 80%
3. **MRR**: ≥ 0.5
4. **90%カバレッジ精度**: ≥ 70%
5. **信頼度校正**: ECE ≤ 0.15

この基準を全て満たした場合のみ「六十四卦マッピングの外的妥当性が検証された」と言える。
