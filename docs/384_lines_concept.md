# 384爻（384 Lines）の概念と実装方針

## 易経の構造

### 基本構造
- **八卦（8 Trigrams）**: 3爻（3本の線）からなる基本単位
  - 各爻は陽爻（─）または陰爻（- -）
  - 2³ = 8通り → 乾/坤/震/巽/坎/離/艮/兌

- **六十四卦（64 Hexagrams）**: 6爻（6本の線）からなる
  - 上卦（外卦）3爻 + 下卦（内卦）3爻
  - 8 × 8 = 64通り

- **384爻（384 Lines）**: 64卦 × 6爻
  - 各卦には6つの爻がある（初爻、二爻、三爻、四爻、五爻、上爻）
  - 各爻は「陽」または「陰」の性質を持つ

### 変爻（Changing Lines）

易経占いでは、**変爻**（へんこう）が重要な概念です：

1. 筮竹や算木で占うと、6つの爻のうち一部が「変化する」と判定される
2. 変化する爻を**変爻**と呼ぶ
3. 変爻によって、本卦（最初の卦）から之卦（変化後の卦）に移行する

**例：**
```
本卦: 乾為天（☰☰）- 全て陽爻
  ↓ 初爻が変化（陽→陰）
之卦: 天風姤（☰☴）- 下卦の初爻が陰になる
```

## 現在のスキーマの課題

現在のスキーマは**八卦ベース**で設計されています：

```python
before_hex: Hex  # 八卦（3爻）
trigger_hex: Hex
action_hex: Hex
after_hex: Hex
```

問題点：
- 八卦（3爻）では変爻を完全には記録できない
- 64卦（6爻）の情報が失われている
- 384爻の網羅性を追跡できない

## 実装方針

### 方針1: 簡易実装（推奨）

各事例で3つの変化（transition）があります：
1. before_hex → trigger_hex
2. trigger_hex → action_hex
3. action_hex → after_hex

各変化について、代表的な変爻パターンを記録：

```python
class Case(BaseModel):
    # 既存フィールド...
    before_hex: Hex
    trigger_hex: Hex
    action_hex: Hex
    after_hex: Hex

    # 新規追加
    changing_lines_1: Optional[List[int]] = None  # before→triggerでの変爻 (1-6)
    changing_lines_2: Optional[List[int]] = None  # trigger→actionでの変爻 (1-6)
    changing_lines_3: Optional[List[int]] = None  # action→afterでの変爻 (1-6)
```

**メリット：**
- スキーマ変更が最小限
- 既存データと互換性あり（Optionalなので）
- 段階的に情報を追加可能

**デメリット：**
- 八卦（3爻）ベースなので、変爻の特定が曖昧な場合がある
- 完全な64卦の情報は記録できない

### 方針2: 完全実装（将来）

64卦ベースで設計し直す：

```python
class Case(BaseModel):
    # 64卦（6爻）を完全に記録
    before_hexagram_64: Hexagram64  # 64卦のEnum
    trigger_hexagram_64: Hexagram64
    action_hexagram_64: Hexagram64
    after_hexagram_64: Hexagram64

    # 各爻の状態を完全記録
    before_lines: List[LineType]  # [陽, 陽, 陰, ...] 6要素
    trigger_lines: List[LineType]
    action_lines: List[LineType]
    after_lines: List[LineType]

    # 変爻を自動計算
    changing_lines_1: List[int]  # before→triggerで変化した爻番号
    changing_lines_2: List[int]
    changing_lines_3: List[int]
```

**メリット：**
- 384爻を完全に追跡可能
- 変爻を正確に記録できる
- より詳細な分析が可能

**デメリット：**
- スキーマの大幅変更が必要
- 既存682件のデータを全て変換する必要がある
- データ入力の負担が大きい

## 採用する実装方針

**方針1（簡易実装）を採用**します。理由：

1. **段階的実装が可能** - 既存データを壊さない
2. **即座に運用開始できる** - 新規事例から変爻情報を記録
3. **将来の拡張に対応** - 後で方針2に移行できる
4. **実用性重視** - 診断ツールには十分な情報量

## 変爻の記録ルール

### 八卦から変爻を推定する方法

八卦の変化から、おおよその変爻を推定できます：

**例1: 乾（☰）→ 兌（☱）**
- 乾: 陽陽陽
- 兌: 陰陽陽
- 変爻: 上爻（3爻目）が変化

**例2: 坎（☵）→ 離（☲）**
- 坎: 陰陽陰
- 離: 陽陰陽
- 変爻: 初爻と上爻が変化

### 記録フォーマット

```json
{
  "changing_lines_1": [1, 3],  // 初爻と三爻が変化
  "changing_lines_2": [2],     // 二爻のみ変化
  "changing_lines_3": null     // 変爻なし（同じ卦）
}
```

- 爻番号: 1=初爻, 2=二爻, 3=三爻, 4=四爻, 5=五爻, 6=上爻
- null = 変爻情報なし（既存データ）
- [] = 変爻なし（同じ卦のまま）

## 実装ステップ

1. ✅ **スキーマ拡張** - changing_lines フィールドを追加（完了）
2. ✅ **変爻推定ロジック** - 八卦ペアから変爻を推定する関数（scripts/infer_changing_lines.py）
3. ✅ **既存データ更新** - 全673件の事例に変爻情報を追加（scripts/add_changing_lines.py）
4. ✅ **分析ツール** - 384爻の網羅性を確認するスクリプト（scripts/analyze_384_lines.py）
5. ✅ **新規データ** - 今後の事例追加時に変爻が自動記録される

### 実装完了後の状況

- **全673事例に変爻情報を追加完了**
- **96個のユニーク(卦ペア, 爻番号)組み合わせを記録**
- **八卦ペアの網羅率: 87.5%** (56/64ペア)
- 最も使用頻度が高い変爻: 乾→離の二爻（134回）

## 期待される効果

1. **診断精度の向上** - 変爻パターンに基づくマッチング
2. **易経的な深み** - より伝統的な易経解釈に近づく
3. **データの価値向上** - 384爻という詳細なレベルでの分析が可能
4. **差別化** - 他の易経DBにはない詳細度
