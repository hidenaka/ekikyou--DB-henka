# 六十四卦マッピング改善計画v6 - ソフトスコアリング方式

## 設計思想

### 従来の問題（ハードゲート方式）
- 「本質八卦」を1つに固定 → 誤ると回復不能
- 複数主題（坎+巽など）を表現できない
- 境界事例で必ず誤分類

### 新アプローチ（ソフトスコアリング方式）
- 上卦・下卦それぞれに**確率分布**を推定
- 64卦を**合成スコア**で順位付け
- **Top-k候補を提示**してユーザー選択または追加絞り込み
- 誤りが回復可能、曖昧性を保持

## アーキテクチャ

```
入力: ビジネス事例テキスト（before/transformation/outcome）
    ↓
[Step 1] テキスト分析
    - 内部要因の抽出
    - 外部要因の抽出
    ↓
[Step 2] 八卦スコア推定（並列）
    - 上卦スコア: P(乾), P(坤), P(震), ... （8次元確率分布）
    - 下卦スコア: P(乾), P(坤), P(震), ... （8次元確率分布）
    ↓
[Step 3] 64卦合成スコア
    - Score(卦i) = P(上卦) × P(下卦)
    - 64卦をスコア順にソート
    ↓
[Step 4] Top-k候補提示
    - 上位5-10候補をユーザーに提示
    - 各候補に説明・根拠を付与
    ↓
[Step 5] 絞り込み（オプション）
    - ユーザーの「本質八卦」指定でフィルタ（15卦に絞る）
    - 追加質問で候補を削減
    ↓
[Step 6] 64卦確定 → 爻判定
    - 確定した卦の爻辞を参照
    - 段階（early/mid/late）または具体的爻（1-6）を判定

出力: (hexagram_number, hexagram_name, yao, confidence, reasoning)
```

## Step 2: 八卦スコア推定の詳細

### 2.1 推定方式の選択肢

**A. LLMベース推定（推奨）**
```
プロンプト:
「以下のビジネス事例について、八卦それぞれの該当度を0-100で評価してください。
合計が100になる必要はありません。各八卦が独立に該当するかどうかを判定してください。

[八卦の定義]
乾: 創始・主導・大胆な拡大
坤: 受容・遂行・地道な継続
震: 突発・衝撃・急な開始
巽: 浸透・適応・徐々の変化
坎: リスク・障害・困難への対処
離: 判断・可視化・明確化
艮: 停止・制約・境界設定
兌: 合意・喜び・交流

[事例]
{before/transformation/outcome}

[出力形式]
上卦スコア（外部環境・結果として表出）:
乾: XX, 坤: XX, 震: XX, 巽: XX, 坎: XX, 離: XX, 艮: XX, 兌: XX

下卦スコア（内部状態・原因として潜在）:
乾: XX, 坤: XX, 震: XX, 巽: XX, 坎: XX, 離: XX, 艮: XX, 兌: XX

推論根拠: ...
」
```

**B. 類似事例検索ベース**
- 事例DBから類似事例をTop-N検索
- 類似事例の卦分布を重み付き集計
- 新規事例のスコアとして使用

**C. ハイブリッド（推奨）**
- LLMで初期スコアを推定
- 類似事例で補正・校正

### 2.2 スコアの正規化

```python
# 各八卦のスコアをsoftmaxで確率化
import numpy as np

def normalize_scores(raw_scores):
    """raw_scores: dict {卦名: 0-100のスコア}"""
    values = np.array(list(raw_scores.values()))
    # 温度パラメータで分布の鋭さを調整
    temperature = 2.0
    probs = np.exp(values / temperature) / np.sum(np.exp(values / temperature))
    return dict(zip(raw_scores.keys(), probs))
```

## Step 3: 64卦合成スコア

### 3.1 基本計算

```python
def compute_hexagram_scores(upper_probs, lower_probs):
    """64卦の合成スコアを計算"""
    hexagram_scores = {}

    for upper_trigram, upper_p in upper_probs.items():
        for lower_trigram, lower_p in lower_probs.items():
            hexagram = get_hexagram(upper_trigram, lower_trigram)
            score = upper_p * lower_p
            hexagram_scores[hexagram] = {
                'score': score,
                'upper': upper_trigram,
                'lower': lower_trigram,
                'upper_prob': upper_p,
                'lower_prob': lower_p
            }

    # スコア順にソート
    return sorted(hexagram_scores.items(), key=lambda x: x[1]['score'], reverse=True)
```

### 3.2 スコア補正（オプション）

- **事前分布の組み込み**: 希少卦にペナルティを与えない/与える
- **卦の意味論的整合性**: 相反する上下の組み合わせにペナルティ

## Step 4: Top-k候補提示

### 4.1 候補の表示形式

```
【候補1】雷水解（40番）- スコア: 0.15
  上卦: 震（突発・衝撃）0.45
  下卦: 坎（困難・リスク）0.33
  解釈: 困難な状況から突破口を開く
  類似事例: ○○社の危機対応（2023年）

【候補2】水雷屯（3番）- スコア: 0.12
  上卦: 坎（困難・リスク）0.33
  下卦: 震（突発・衝撃）0.36
  解釈: 困難の中での新たな始まり
  類似事例: △△社の創業期（2019年）

...
```

### 4.2 Top-kの決定基準

- **デフォルト**: k=5（上位5候補）
- **曖昧な場合**: k=10（スコア差が小さい場合）
- **明確な場合**: k=3（Top-1が突出している場合）

```python
def determine_k(scores):
    """スコア分布に基づいてkを決定"""
    top1_score = scores[0][1]['score']
    top5_score = scores[4][1]['score'] if len(scores) > 4 else 0

    ratio = top1_score / top5_score if top5_score > 0 else float('inf')

    if ratio > 3.0:  # Top-1が突出
        return 3
    elif ratio < 1.5:  # 分布が平坦
        return 10
    else:
        return 5
```

## Step 5: 絞り込みオプション

### 5.1 本質八卦によるフィルタ（ユーザーのアイデアを活用）

```
ユーザー: 「この事例は本質的に"震"（衝撃・突発）だと思う」
    ↓
システム: 震が関わる15卦にフィルタ
    ↓
15卦の中でスコア順に再提示
```

### 5.2 追加質問による絞り込み

```
システム: 「上位候補が拮抗しています。以下の質問に答えてください」

Q1: この変化は主に内部から起きましたか、外部から起きましたか？
  - 内部主導 → 下卦を重視
  - 外部主導 → 上卦を重視

Q2: 結果は確定していますか、まだ進行中ですか？
  - 確定 → 離・乾を上げる
  - 進行中 → 震・巽を上げる
```

## Step 6: 爻判定

### 6.1 64卦確定後の爻判定

```python
def determine_yao(hexagram_number, outcome_text):
    """64卦が確定した後、その卦の文脈で爻を判定"""

    # その卦の爻辞を取得
    yao_descriptions = get_yao_descriptions(hexagram_number)

    # LLMに爻判定を依頼
    prompt = f"""
    以下の事例の結果を、{hexagram_number}番卦の6つの爻のどれに該当するか判定してください。

    [事例の結果]
    {outcome_text}

    [爻の説明]
    初爻: {yao_descriptions[1]}
    二爻: {yao_descriptions[2]}
    三爻: {yao_descriptions[3]}
    四爻: {yao_descriptions[4]}
    五爻: {yao_descriptions[5]}
    上爻: {yao_descriptions[6]}

    [判定]
    最も該当する爻: X
    理由: ...
    """
    return llm_judge(prompt)
```

### 6.2 段階ベースの簡易判定（フォールバック）

```
early (爻1-2): 計画中、準備中、開始前
mid (爻3-4): 実行中、展開中、転換期
late (爻5-6): 完了、成功、失敗、移行
```

## 評価指標

### 必須指標

| 指標 | 定義 | 目標 |
|------|------|------|
| 64卦 Top-1精度 | 正解がTop-1に含まれる率 | ≥ 35% |
| 64卦 Top-5再現率 | 正解がTop-5に含まれる率 | ≥ 70% |
| 64卦 Top-10再現率 | 正解がTop-10に含まれる率 | ≥ 85% |
| MRR | 平均逆順位 | ≥ 0.4 |
| 上卦 Top-1精度 | 上卦の正解一致率 | ≥ 55% |
| 下卦 Top-1精度 | 下卦の正解一致率 | ≥ 55% |
| ECE | 信頼度校正誤差 | ≤ 0.2 |

### 運用指標

| 指標 | 定義 | 目標 |
|------|------|------|
| ユーザー選択率 | Top-k提示後にユーザーが選択できた率 | ≥ 90% |
| 絞り込み使用率 | 本質八卦フィルタ等を使用した率 | 測定のみ |
| 平均候補数 | ユーザーに提示された候補数の平均 | 5-7 |

## 工数見積もり

| フェーズ | 内容 | 工数 |
|----------|------|------|
| 設計 | アーキテクチャ・プロンプト設計 | 16h |
| 実装 | スコアリング・候補提示・UI | 24h |
| パイロット | 100件でのスコア校正 | 20h |
| ゴールドセット | 400件の正解データ作成 | 80h |
| 評価・調整 | 指標測定・温度調整・閾値設定 | 16h |
| **合計** | | **156h** |

## フォールバック

| 条件 | 対応 |
|------|------|
| Top-5再現率 < 60% | Top-10に拡大 |
| 上卦/下卦精度 < 45% | 類似事例検索を強化 |
| ユーザー選択率 < 80% | 絞り込み質問を必須化 |
| 全体破綻 | 八卦レベル（8クラス）に撤退 |

## v5からの主な変更

| 項目 | v5 | v6 |
|------|-----|-----|
| 推定方式 | 決定木（ハードゲート） | 確率分布（ソフトスコアリング） |
| 出力形式 | 単一ラベル | Top-k候補 |
| 誤り回復 | 不可能 | 可能 |
| 複数主題 | 非対応 | 確率で表現 |
| 爻判定 | 汎用3段階 | 64卦確定後に卦固有判定 |
| ユーザー関与 | なし | 候補選択・絞り込み |
