# 六十四卦マッピング改善計画v2

## 背景と問題認識

Codex (GPT-5.2) の批評を受け、以下の問題を認識：

1. **「適合度100%」は評価ではない** - 自己一致の確認に過ぎず、外的妥当性は未検証
2. **confidence式が不適切** - `マッチ数/最大キーワード数`は確率でも信頼度でもない
3. **爻の統一化と易経意味論チェックが矛盾** - 汎用工程表と卦辞・爻辞の整合は両立しない
4. **100件では統計的に不十分** - 64卦×6爻の高分割ラベル空間に対して薄すぎる
5. **キーワードベース分類の根本的限界** - 語彙揺れ・否定・比喩に弱い

## 設計原則（Codex提案を採用）

> 「易経らしさ」より先に、**再現可能なラベル体系と検証可能な分類器**を作る。
> 易経意味論は**解釈レイヤ**として後から載せる。

## 改善計画（6ステップ）

### Step 1: タスク定義の固定（1-2時間）

**目標**: 入力→出力の形式を一意に定義し、unknownの正義条件を明文化

**成果物**:
- `docs/task_definition.md` - タスク定義書

**内容**:
```
入力: ビジネス事例テキスト（before/transformation/outcome）
出力:
  - trigger: 変化の契機（8種類 + unknown）
  - action: 対応行動（8種類 + unknown）
  - yao: プロセス段階（1-6 + unknown）

unknown条件:
  - trigger: 変化の契機が明示されていない、または複数が同等に該当
  - action: 対応行動が明示されていない、または複数が同等に該当
  - yao: プロセス段階が特定不能、または複数段階が混在
```

### Step 2: アノテーションガイドライン作成（3-4時間）

**目標**: 判定基準を明文化し、再現可能なラベリングを実現

**成果物**:
- `docs/annotation_guidelines.md` - アノテーションガイドライン

**内容**:
1. **ラベル定義**: 各trigger/action/爻の判定基準
2. **判定例**: 各カテゴリに典型例3件、境界例2件
3. **裁定手順**: 不一致時の決着方法
4. **禁止事項**: 結果からの逆算禁止（outcome→triggerの推測等）

**爻の判定基準（プロセス段階）**:
```
爻1: 変化の兆し・情報収集段階（潜龍）
爻2: 計画・準備段階（見龍）
爻3: 実行開始・試行錯誤（夕惕）
爻4: 転換点・方向修正（或躍）
爻5: 安定・成熟段階（飛龍）
爻6: 極限・終末・移行（亢龍）
```

### Step 3: パイロットアノテーション（4-6時間）

**目標**: ガイドラインの破綻点を特定し、修正

**方法**:
1. 層化サンプリングで20件抽出（希少卦優先）
2. 2名の独立アノテーション（Claude + 別LLMまたは人間）
3. 不一致箇所を分析し、ガイドライン修正
4. 修正後、再度20件で確認

**評価指標**:
- trigger/action: Cohen's Kappa ≥ 0.7（多クラス補正版）
- yao: 重み付きKappa ≥ 0.7（順序尺度）

**破綻点チェックリスト**:
- [ ] 否定文での誤判定（「進めない」→進行と誤認）
- [ ] 複合因果での判定揺れ
- [ ] 結果からの逆算バイアス
- [ ] 境界事例での判断基準

### Step 4: ゴールドセット構築（8-12時間）

**目標**: 検証用の確定ラベルデータを作成

**方法**:
1. **難例中心サンプリング**: 現行分類で低confidence/境界/unknown候補を優先
2. **サンプルサイズ**: 最低200件（64卦×3件程度 + 難例補充）
3. **アノテーション**: 2名独立 + 不一致時は裁定（第3者または合議）
4. **確定ラベル**: 合意ラベルをゴールドとして記録

**難例の定義**:
- 複数のtrigger/actionが同等に該当しそうな事例
- プロセスが複数段階にまたがる事例
- 否定・対比・比喩を含む事例

### Step 5: 分類器の改善と校正（6-10時間）

**目標**: 確率的信頼度を持つ分類器を構築

**アプローチ選択肢**:

A. **キーワードベース改善版**
- TF-IDF重み付け（識別力を考慮）
- 確率的スコア（softmax正規化）
- 棄却（abstain）閾値の校正

B. **LLMベース分類**（推奨）
- Few-shot prompting with 典型例
- 出力: (label, confidence, reasoning)
- confidence校正: ゴールドセットで閾値決定

**評価プロトコル**:
1. ゴールドセットを訓練用(60%)/検証用(20%)/テスト用(20%)に分割
2. 検証用でconfidence閾値を決定
3. テスト用で最終精度を報告

**報告指標**:
- Precision/Recall/F1（各カテゴリ + マクロ平均）
- 棄却率とカバレッジのトレードオフ曲線
- 誤分類パターンの分析（confusion matrix）

### Step 6: 易経意味論の検証（後回し・条件付き）

**前提条件**: Step 5で分類器の精度がF1≥0.7を達成

**目標**: 分類結果と易経の卦辞・爻辞の整合性を検証

**方法**:
- 反証可能なチェックリストを作成
- 不整合の定義を明文化（恣意的整合を禁止）
- 不整合事例はログ化し、分類定義の修正は最小限に

**チェックリスト例**:
```
□ trigger「震」の事例に、静的・緩やかな契機が含まれていないか
□ action「坤」の事例に、積極的・攻撃的な行動が含まれていないか
□ 爻1の事例が、成熟・完成・終末を表していないか
```

## スケジュール概要

| Step | 内容 | 想定時間 | 依存関係 |
|------|------|----------|----------|
| 1 | タスク定義 | 1-2h | なし |
| 2 | ガイドライン | 3-4h | Step 1 |
| 3 | パイロット | 4-6h | Step 2 |
| 4 | ゴールドセット | 8-12h | Step 3 |
| 5 | 分類器改善 | 6-10h | Step 4 |
| 6 | 易経意味論 | 条件付き | Step 5 |

**合計**: 22-34時間（Step 6除く）

## 成功基準

1. **アノテーター間一致度**: trigger/action κ≥0.7、yao 重み付きκ≥0.7
2. **分類器精度**: テストセットでF1≥0.7（unknown除く）
3. **棄却率**: 15%以下（unknown率）
4. **再現性**: 同一入力に対して同一出力が保証される

## 失敗時のフォールバック

- Step 3で一致度が低い場合: ガイドラインを修正し、カテゴリ統合も検討
- Step 5で精度が低い場合: LLMベース分類に切り替え、またはカテゴリ粒度を下げる
- 全体が破綻した場合: 卦レベル（64クラス）を諦め、八卦レベル（8クラス）に簡素化

## 現行実装との差分

| 項目 | 現行 | v2 |
|------|------|-----|
| タスク定義 | 暗黙 | 明文化 |
| unknown | なし（強制割当） | あり（棄却許可） |
| confidence | マッチ数/最大数 | 校正された確率 |
| 評価 | 自己一致100% | 外部ゴールドセットで精度測定 |
| 爻決定 | 結果ベース | プロセス段階ベース |
| 易経意味論 | 先行チェック | 後回し（条件付き） |
