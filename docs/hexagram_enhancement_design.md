# 64卦×386爻 特性反映システム設計書

## 目標

現在の精度71%を、卦と爻の個別特性を反映することで80%以上に向上させる。

## 現状分析

### データカバレッジ

| 項目 | 現状 | 目標 |
|------|------|------|
| 卦の出現 | 44/64 (69%) | 64/64 (100%) |
| 卦×爻の組み合わせ | 103/384 (27%) | 384/384 (100%) |
| ケースに卦IDあり | 2839/8449 (34%) | 8449/8449 (100%) |

### 不足データ

- 20卦が未出現
- 281の卦×爻組み合わせがデータなし
- 用九（乾の第7爻）、用六（坤の第7爻）のデータなし

---

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    予測システム v2                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 卦特性DB    │  │ 爻辞DB      │  │ ケースDB    │         │
│  │ (64卦)      │  │ (386爻)     │  │ (8449件+)   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │               │               │                  │
│         └───────────────┼───────────────┘                  │
│                         ▼                                  │
│              ┌─────────────────────┐                       │
│              │ 卦×爻 特性マトリクス │                       │
│              │ (386パターン)        │                       │
│              └──────────┬──────────┘                       │
│                         ▼                                  │
│              ┌─────────────────────┐                       │
│              │ 予測エンジン v2      │                       │
│              │ ・卦の性質を考慮     │                       │
│              │ ・爻辞の意味を反映   │                       │
│              │ ・行動との相性判定   │                       │
│              └─────────────────────┘                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    データ収集システム                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ ギャップ    │  │ リサーチ    │  │ ケース      │         │
│  │ 分析ツール  │→│ ワークフロー │→│ 追加ツール  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  機能:                                                      │
│  ・不足データの特定                                         │
│  ・優先順位付け                                             │
│  ・リサーチタスク生成                                       │
│  ・Web検索による事例収集                                    │
│  ・ケースデータへの変換                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 1. 卦特性データベース

### スキーマ

```json
{
  "hexagram_id": 1,
  "name": "乾為天",
  "chinese_name": "乾",
  "keyword": "創造・リーダーシップ・天",

  "nature": {
    "element": "天",
    "movement": "上昇・前進",
    "timing": "始動期に最適",
    "warning": "傲慢・強行の危険"
  },

  "business_context": {
    "favorable_actions": ["攻める・挑戦", "刷新・破壊"],
    "unfavorable_actions": ["守る・維持", "耐える・潜伏"],
    "optimal_timing": "新規事業立ち上げ、リーダーシップ発揮時",
    "risk_factors": ["過信", "独断専行", "周囲との軋轢"]
  },

  "yao_specifics": {
    "1": {
      "phrase": "潜龍勿用",
      "meaning": "まだ時期ではない。力を蓄えよ",
      "action_modifier": {"攻める・挑戦": -2, "耐える・潜伏": +1}
    },
    "2": { ... },
    ...
    "6": {
      "phrase": "亢龍有悔",
      "meaning": "行き過ぎれば後悔する",
      "action_modifier": {"攻める・挑戦": -3, "捨てる・撤退": +2}
    },
    "用九": {
      "phrase": "見群龍無首、吉",
      "meaning": "リーダーなき群龍、吉。謙虚であれ",
      "special_case": true
    }
  }
}
```

---

## 2. ギャップ分析ツール

### 機能

1. **カバレッジ分析**: どの卦×爻が不足しているか
2. **優先度計算**:
   - 出現頻度が高い卦を優先
   - 予測精度が低いパターンを優先
3. **リサーチタスク生成**: 調査すべき事例のリスト作成

### 出力例

```
=== データギャップ分析レポート ===

【高優先度】（頻出だがデータ不足）
1. 坎為水(29) - 0件 → 危機・困難の卦、重要
2. 艮為山(52) - 0件 → 停止・待機の卦、重要
3. 震為雷(51) - 0件 → 衝撃・始動の卦、重要

【中優先度】（特定爻のデータ不足）
4. 乾為天(1) 3爻 - 5件 → 「乾乾夕惕」の解釈が必要
5. 坤為地(2) 4爻 - 3件 → 「括嚢」の解釈が必要

【リサーチタスク】
- 「坎為水」に該当する企業危機事例を10件収集
- 「艮為山」に該当する事業撤退事例を10件収集
```

---

## 3. リサーチワークフロー

### プロセス

```
1. ギャップ分析
   ↓
2. 優先度に基づきターゲット卦を選定
   ↓
3. 該当する事例をWeb検索
   例: 「企業 危機 V字回復 事例」で坎為水のケース探し
   ↓
4. 事例を分析してケースデータに変換
   ↓
5. 卦×爻の割り当て
   ↓
6. ケースDBに追加
   ↓
7. モデル再訓練
   ↓
8. 精度検証
```

### 自動化ポイント

- Web検索によるキーワード検索
- 事例の構造化（before_state, action_type, outcome抽出）
- 卦の自動推定（状態から逆引き）

---

## 4. 卦×爻 予測エンジン v2

### 予測フロー

```python
def predict_v2(before_state, action_type, hexagram_id=None):
    # Step 1: 基本予測（現行モデル）
    base_prediction = predict_v1(before_state, action_type)

    # Step 2: 卦が特定されている場合、特性を反映
    if hexagram_id:
        hex_profile = get_hexagram_profile(hexagram_id)
        yao_position = diagnose_yao_position(before_state)
        yao_specifics = hex_profile['yao_specifics'][yao_position]

        # 行動との相性を調整
        modifier = yao_specifics['action_modifier'].get(action_type, 0)
        adjusted_score = base_prediction['score'] + modifier

        # 卦の警告を確認
        if action_type in hex_profile['business_context']['unfavorable_actions']:
            adjusted_score -= 1

        return apply_adjusted_score(adjusted_score)

    return base_prediction
```

### 期待効果

| ケース | 現行精度 | 卦反映後期待 |
|--------|----------|--------------|
| 卦IDあり | 71% | 80%+ |
| 卦IDなし | 71% | 71%（変化なし）|

---

## 5. 実装計画

### Phase 1: 基盤構築（必須）

1. 64卦特性データベースの作成
2. ギャップ分析ツールの実装
3. 既存ケースへの卦ID付与強化

### Phase 2: データ拡充

1. 不足卦のリサーチワークフロー
2. 事例収集と構造化
3. ケースDB拡充

### Phase 3: モデル改善

1. 卦×爻特性を反映した予測エンジン
2. 精度検証
3. 反復改善

---

## ファイル構成

```
易経変化ロジックDB/
├── data/
│   ├── hexagrams/
│   │   ├── hexagram_profiles.json    # 64卦特性DB
│   │   └── yao_action_modifiers.json # 爻×行動調整値
│   └── analysis/
│       ├── gap_analysis.json         # ギャップ分析結果
│       └── research_tasks.json       # リサーチタスクリスト
├── scripts/
│   ├── analyze_gaps.py               # ギャップ分析
│   ├── generate_research_tasks.py    # タスク生成
│   └── enrich_hexagram_ids.py        # 卦ID付与強化
└── harness/
    ├── research_workflow.py          # リサーチワークフロー
    ├── case_collector.py             # 事例収集
    └── predict_v2.py                 # 改善版予測
```
