# 六十四卦マッピング改善計画v4

## Codex批評v3からの学び

1. **八卦定義に排反性がない** - キーワード列挙では弁別不能
2. **「下卦=before、上卦=transformation」は恣意的** - 文章依存を捨てるべき
3. **成功基準が数学的に不整合** - 階層分解の評価指標を明確に
4. **unknownが逃げ道になる** - 適用条件を厳密に定義すべき
5. **対立ペアの判別規則がない** - 乾vs震、坎vs艮などの衝突解決が必要

## v4の設計原則

> **弁別可能なラベル定義を最優先**
> キーワードではなく「判定軸+優先規則+対立ペア判別規則」で八卦を定義
> 階層分解の評価指標を数学的に整合させる

## Step 1: 八卦の弁別可能な定義

### 1.1 判定軸の設計

八卦を**3つの二値軸**で定義（易経の本来の構造に準拠）：

| 軸 | 陽 (+) | 陰 (-) | 判定基準 |
|----|--------|--------|----------|
| 動静軸 | 動的・変化中 | 静的・安定 | 状況/行動に動きがあるか |
| 強弱軸 | 強い・支配的 | 弱い・従属的 | 主体性/影響力の強さ |
| 明暗軸 | 明確・顕在 | 不明確・潜在 | 可視性/表出度 |

### 1.2 八卦の軸定義（排反性確保）

| 卦 | 動静 | 強弱 | 明暗 | ビジネス解釈 |
|----|------|------|------|--------------|
| 乾 | + | + | + | 攻勢・主導・明確な拡大 |
| 坤 | - | - | - | 受容・従属・潜在的対応 |
| 震 | + | + | - | 急変・強力だが不透明 |
| 巽 | + | - | - | 徐々に浸透・弱く不透明 |
| 坎 | + | - | + | リスク顕在・弱いが可視 |
| 離 | - | + | + | 安定的に強く可視化 |
| 艮 | - | + | - | 停止・強いが潜在 |
| 兌 | - | - | + | 安定的に弱いが可視 |

### 1.3 対立ペアの判別規則

| 対立 | 判別基準 |
|------|----------|
| 乾 vs 震 | 明確性：計画的攻勢(乾) vs 突発的変化(震) |
| 坎 vs 艮 | 動静：リスク対応中(坎) vs 停止・待機(艮) |
| 離 vs 兌 | 強弱：主導的公開(離) vs 協調的交流(兌) |
| 巽 vs 坤 | 動静：徐々に適応中(巽) vs 完全に受動(坤) |

### 1.4 判定フロー

```
1. 動静軸を判定（動きがあるか？）
2. 強弱軸を判定（主体性があるか？）
3. 明暗軸を判定（可視化されているか？）
4. 3軸の組み合わせで八卦を決定
5. 境界事例は対立ペア判別規則で解決
```

## Step 2: 上卦/下卦の意味割当（文章依存を排除）

### 2.1 内外モデル

| 位置 | 意味 | 対応する情報 |
|------|------|--------------|
| 下卦 | 内的要因 | 組織内部の状態、資源、能力、文化 |
| 上卦 | 外的要因 | 市場環境、競合、規制、顧客、技術動向 |

### 2.2 判定ルール

- **下卦**: 「before」の記述から内部要因を抽出 → 3軸判定
- **上卦**: 「before」「transformation」から外部要因を抽出 → 3軸判定
- **混在時**: 内部/外部を先に分類してから3軸判定

### 2.3 反例対策

- 内部/外部が不明確な場合: 主語で判定（自社→内部、市場/競合→外部）
- 両方が同等に記述されている場合: 主たる記述を優先

## Step 3: unknownの厳密な分割

| unknown種別 | 定義 | 適用条件 |
|-------------|------|----------|
| unknown_missing | 情報欠落 | 判定に必要な情報が記述されていない |
| unknown_tie | 同点 | 複数の八卦が同等に該当（優先規則でも解決不能） |
| unknown_outofscope | 範囲外 | ビジネス事例ではない、または易経の枠組みに当てはまらない |

### 適用条件の断言形規定

- **unknown_missing**: 3軸のうち2軸以上が判定不能の場合のみ適用
- **unknown_tie**: 対立ペア判別規則を適用しても決着しない場合のみ適用
- **unknown_outofscope**: ビジネス変化の記述がない場合のみ適用

**禁止**: 判定が難しいという理由だけでunknownに逃げることは禁止

## Step 4: 評価指標の整合設計

### 4.1 階層分解の評価指標

**主指標: 候補集合再現率（Candidate Set Recall）**

```
上卦Top-k × 下卦Top-k → 候補64卦集合（最大k²個）
正解卦がこの候補集合に含まれる割合
```

例: k=3の場合、候補集合は最大9個の64卦を含む

### 4.2 評価指標一覧

| 指標 | 定義 | 目標 |
|------|------|------|
| 上卦Top-1精度 | 上卦の正解一致率 | ≥ 65% |
| 下卦Top-1精度 | 下卦の正解一致率 | ≥ 65% |
| **候補集合再現率@k=3** | 正解が候補9個に含まれる率 | ≥ 85% |
| 64卦Top-1精度 | 上卦×下卦の完全一致率 | ≥ 45% |
| 段階Top-1精度 | early/mid/lateの一致率 | ≥ 70% |
| 棄却時精度向上 | abstain時の誤り削減率 | 測定のみ |

### 4.3 数学的整合性

上卦精度65% × 下卦精度65% = 約42%（64卦Top-1精度の理論下限）
候補集合再現率@k=3 ≈ 1 - (1-0.65)³ × (1-0.65)³ ≈ 91%（独立性仮定時の理論値）

## Step 5: アノテーション設計（現実的工数）

### 5.1 パイロット: 100件（二重アノテーション）

| 工程 | 内容 | 工数 |
|------|------|------|
| サンプリング | 層化抽出 | 2h |
| アノテーション1 | ラベラーA | 8h |
| アノテーション2 | ラベラーB | 8h |
| 不一致分析 | 破綻点特定 | 4h |
| ガイドライン修正 | 判別規則追加 | 4h |
| **合計** | | **26h** |

**合格基準**:
- 上卦κ ≥ 0.55、下卦κ ≥ 0.55、段階重み付きκ ≥ 0.60
- unknown率 ≤ 15%

### 5.2 ゴールドセット: 400件（二重+調停）

| 工程 | 内容 | 工数 |
|------|------|------|
| サンプリング | 難例優先 | 4h |
| アノテーション1 | ラベラーA | 32h |
| アノテーション2 | ラベラーB | 32h |
| 調停 | 不一致解決（推定20%） | 16h |
| 品質検証 | 一致度再計算 | 4h |
| **合計** | | **88h** |

**分割**: 訓練240件 / 検証80件 / テスト80件

## Step 6: 分類器の構築

### 6.1 アーキテクチャ

```
入力テキスト
    ↓
[内外分離] 内部要因/外部要因の文を分離
    ↓
[3軸判定] 各要因に対して動静/強弱/明暗を判定
    ↓
[八卦決定] 3軸→八卦のルール適用
    ↓
[候補生成] 上卦Top-3 × 下卦Top-3 → 候補9個
    ↓
[順位付け] 候補を類似事例との距離でランキング
    ↓
出力: 候補リスト + 信頼度 + 根拠
```

### 6.2 abstain設計

**abstain条件**（率ではなく精度で縛る）:
- カバレッジ90%時の精度を測定
- abstain時の誤り削減率を報告

```
abstain判定:
  IF max(上卦信頼度) < θ_upper OR max(下卦信頼度) < θ_lower:
    abstain = True
    reason = "信頼度不足"
```

θは検証セットで決定（精度-カバレッジ曲線から選択）

## 工数総括

| フェーズ | 工数 |
|----------|------|
| Step 1-3: 定義設計 | 16h |
| Step 5.1: パイロット100件 | 26h |
| Step 5.2: ゴールド400件 | 88h |
| Step 6: 分類器構築 | 24h |
| **合計** | **154h** |

## v3からの主な変更

| 項目 | v3 | v4 |
|------|-----|-----|
| 八卦定義 | キーワード列挙 | 3軸+対立ペア判別規則 |
| 上卦/下卦意味 | before/transformation | 内的/外的要因 |
| unknown | 単一 | 3種類に分割+適用条件 |
| 主評価指標 | 個別精度 | 候補集合再現率 |
| パイロット | 50件 | 100件（二重アノテ） |
| ゴールドセット | 500件 | 400件（二重+調停） |
| abstain | 率で制約 | 精度で制約 |

## フォールバック

1. **κ < 0.5**: 3軸を2軸に簡素化（動静+強弱）
2. **候補集合再現率@k=3 < 70%**: k=5に拡大
3. **unknown率 > 25%**: 適用条件を緩和して強制ラベル比率を上げる
4. **全体破綻**: 八卦（8クラス）に撤退、64卦を諦める
