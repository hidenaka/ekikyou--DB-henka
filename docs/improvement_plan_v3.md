# 六十四卦マッピング改善計画v3

## Codex批評v2からの学び

v2に対するCodex批評の核心：
1. **64卦ラベルの操作的定義が欠落** - 意味論を後回しにしても定義は必要
2. **爻＝汎用プロセス段階は卦の文脈依存性を破壊**
3. **unknown（真ラベル）とabstain（棄却）の混同**
4. **64クラス直当てより階層分解（上卦・下卦）が優れている**
5. **データサイズ・時間見積もりが非現実的**

## v3の設計原則

> **階層分解 + 検索ベース + 実用的な粒度**
> 64クラス直接分類を避け、上卦・下卦を別々に推定し、爻は粗い3段階に簡素化

## 改善計画（5ステップ）

### Step 1: 出力仕様の確定

**成果物**: `docs/output_spec_v3.md`

```yaml
出力仕様:
  upper_trigram:    # 上卦 (1..8 または unknown)
    value: string   # 乾/坤/震/巽/坎/離/艮/兌/unknown
    confidence: float
    evidence_span: string

  lower_trigram:    # 下卦 (1..8 または unknown)
    value: string
    confidence: float
    evidence_span: string

  hexagram:         # 合成結果 (1..64)
    number: int
    name: string
    abstain: boolean  # モデルが棄却判断

  stage:            # 段階（3段階に簡素化）
    value: string   # early / mid / late / unknown
    confidence: float
    evidence_span: string

  model_action:
    abstain: boolean      # モデルの棄却行動
    abstain_reason: string
```

**unknown vs abstain の区別**:
- `unknown`: 入力データに情報がない（真ラベル）
- `abstain`: モデルの信頼度が低い（モデル行動）

### Step 2: 八卦（上卦・下卦）の操作的定義

**成果物**: `docs/trigram_definitions.md`

**八卦の操作的定義**（ビジネス文脈）:

| 卦 | 契機として | 行動として | 判定キーワード例 |
|----|----------|----------|----------------|
| 乾 | 創業、革新、大胆な決断 | 攻勢、拡大、リーダーシップ | 創業、新規、攻め、主導 |
| 坤 | 市場成熟、外部圧力 | 受容、忍耐、フォロワー戦略 | 受け入れ、待つ、従う |
| 震 | 危機、衝撃、突発事態 | 行動開始、決起、迅速対応 | 危機、衝撃、即座に |
| 巽 | 市場変化、規制変更 | 浸透、適応、柔軟対応 | 適応、浸透、調整 |
| 坎 | リスク顕在化、困難 | 慎重、リスク管理、撤退 | 困難、撤退、慎重 |
| 離 | 注目、評価、可視化 | 公開、ブランディング、透明化 | 公開、発表、可視化 |
| 艮 | 成長停滞、壁、限界 | 停止、見直し、内省 | 停止、見直し、休止 |
| 兌 | 機会、協力、交流 | 交渉、連携、顧客対応 | 連携、交渉、顧客 |

**判定ルール**:
1. before（変化前）の状況記述から **下卦** を推定
2. transformation（変化内容）の行動記述から **上卦** を推定
3. 上卦×下卦で64卦を合成

### Step 3: 段階（stage）の3段階定義

**成果物**: `docs/stage_definitions.md`

**3段階定義**（爻1-6を統合）:

| 段階 | 元の爻 | 定義 | 判定基準 |
|------|--------|------|----------|
| early | 1-2爻 | 兆し・準備段階 | 計画中、検討中、開始前、試験的 |
| mid | 3-4爻 | 実行・転換段階 | 実行中、展開中、方針転換、岐路 |
| late | 5-6爻 | 成熟・終末段階 | 完成、成功、失敗、終了、次への移行 |

**判定ルール**:
- outcome（結果）の記述から段階を推定
- 複数段階にまたがる場合は主要な段階を選択

### Step 4: アノテーション設計と検証

**Phase 4-A: パイロット（50件）**

目的: ガイドラインの破綻点を特定

方法:
1. 層化サンプリングで50件抽出
2. 2名独立アノテーション
3. 上卦・下卦・段階それぞれで一致度測定

評価指標:
- 上卦/下卦: Cohen's Kappa（8クラス）
- 段階: 重み付きKappa（3段階順序尺度）

目標: 各κ ≥ 0.6（50件での暫定基準）

**Phase 4-B: ゴールドセット構築（500件）**

構成:
- 各卦8件程度（64×8 = 512件）
- 難例を優先的に含む

方法:
- 2名独立 + 不一致時は裁定
- 裁定ログを残す（恣意的決定を防止）

分割:
- 訓練用: 60%（300件）
- 検証用: 20%（100件）
- テスト用: 20%（100件）

### Step 5: 分類器の構築と評価

**アプローチ: 検索+LLM分類のハイブリッド**

```
入力テキスト
    ↓
[Step A] 類似事例検索（Top-5）
    ↓
[Step B] LLMに類似例を提示してFew-shot分類
    ↓
出力: (upper_trigram, lower_trigram, stage, confidence, reasoning)
```

**評価プロトコル**:

1. **Top-1精度**: 正解との完全一致率
2. **Top-3精度**: 上位3候補に正解が含まれる率
3. **棄却率**: abstainの割合
4. **coverage-accuracy曲線**: 閾値ごとのトレードオフ

**成功基準**:

| 指標 | 目標 |
|------|------|
| 上卦 Top-1精度 | ≥ 70% |
| 下卦 Top-1精度 | ≥ 70% |
| 64卦 Top-3精度 | ≥ 80% |
| 段階 Top-1精度 | ≥ 75% |
| 棄却率 | ≤ 10% |

## 現実的な工数見積もり

| Step | 内容 | 想定工数 |
|------|------|----------|
| 1 | 出力仕様確定 | 2-3時間 |
| 2 | 八卦定義 | 4-6時間 |
| 3 | 段階定義 | 2-3時間 |
| 4-A | パイロット50件 | 8-12時間 |
| 4-B | ゴールド500件 | 40-60時間 |
| 5 | 分類器構築・評価 | 16-24時間 |

**合計**: 72-108時間（Step 4-Bが最大ボトルネック）

## v2からの主な変更点

| 項目 | v2 | v3 |
|------|-----|-----|
| 分類方式 | 64クラス直接 | 階層分解（上卦×下卦） |
| 爻/段階 | 6段階（爻1-6） | 3段階（early/mid/late） |
| unknown | データ属性のみ | データ属性 + モデル棄却を分離 |
| データサイズ | 200件 | 500件 |
| 評価 | Top-1のみ | Top-1 + Top-3 |
| 八卦定義 | 暗黙 | 操作的定義を明文化 |

## フォールバック

1. **κ ≤ 0.5**: 8卦をさらに4グループに統合
2. **Top-3精度 ≤ 60%**: 候補数をTop-5に拡大
3. **全体破綻**: 八卦レベル（8クラス）に撤退

## 易経意味論の位置づけ

v3では易経意味論を「検証対象」ではなく「解釈レイヤ」として扱う。

- 分類器の出力は「ビジネス事例の構造化ラベル」
- 易経の卦辞・爻辞は「ラベルに対する解釈・助言」
- 両者の整合性は後続の別プロジェクトで検証

この分離により、分類器の品質評価と易経解釈の妥当性評価を独立に行える。
