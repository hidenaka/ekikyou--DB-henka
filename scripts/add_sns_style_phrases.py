#!/usr/bin/env python3
"""
384çˆ»ã«SNSé¢¨ã®ç¾ä»£èªè§£èª¬ã‚’è¿½åŠ ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

çˆ»è¾ã®æ„å‘³ã‚’ã€SNS/Twitter/TikTokã§ä½¿ã‚ã‚Œã‚‹ã‚ˆã†ãª
ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§åˆºã•ã‚‹ãƒ¯ãƒ¼ãƒ‰ã§å†è§£é‡ˆã™ã‚‹ã€‚
"""

import json
from pathlib import Path

BASE_DIR = Path(__file__).parent.parent

# å…¥å‡ºåŠ›ãƒ‘ã‚¹
YAO_MASTER = BASE_DIR / "data" / "hexagrams" / "yao_master.json"
YAO_RECOMMENDATIONS = BASE_DIR / "data" / "reference" / "yao_recommendations.json"

# çˆ»ä½ç½®ã¨æ®µéšã«å¿œã˜ãŸSNSé¢¨ã®ãƒ™ãƒ¼ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º
STAGE_SNS_TEMPLATES = {
    1: [
        "ä»Šã¯ä»•è¾¼ã¿ã®ã‚¿ãƒ¼ãƒ³ã€‚",
        "ã¾ã å‹•ããªã€æº–å‚™ãŒå…ˆã€‚",
        "ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã«ç«‹ã£ãŸã ã‘ã€‚",
        "ç„¦ã‚‹ãªã€åŠ›ã‚’è“„ãˆã‚ã€‚",
    ],
    2: [
        "åœ°é“ãŒæœ€å¼·ã€‚",
        "ã‚³ãƒ„ã‚³ãƒ„ãŒå‹ã¤æ™‚æœŸã€‚",
        "ä¿¡é ¼ã‚’ç©ã¿ä¸Šã’ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã€‚",
        "å®Ÿç¸¾ãŒå…¨ã¦ã€‚",
    ],
    3: [
        "åˆ†å²ç‚¹ã€é¸æŠãƒŸã‚¹ã‚‹ãªã€‚",
        "ã“ã“ãŒè¸ã‚“å¼µã‚Šã©ã“ã‚ã€‚",
        "è¿·ã£ãŸã‚‰ç«‹ã¡æ­¢ã¾ã‚Œã€‚",
        "ãƒªã‚¹ã‚¯è¦‹æ¥µã‚ã‚ã€‚",
    ],
    4: [
        "è¬™è™šã•ãŒæ­¦å™¨ã€‚",
        "å‡ºéãã‚‹ã¨æ½°ã•ã‚Œã‚‹ã€‚",
        "ä¸Šã¨ã®é–¢ä¿‚ãŒã‚«ã‚®ã€‚",
        "ç©ºæ°—èª­ã‚ã€‚",
    ],
    5: [
        "ä»ŠãŒå‹è² ã©ãã€‚",
        "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ç™ºæ®ã—ã‚ã€‚",
        "æ±ºæ–­ã®æ™‚ã€‚",
        "è²¬ä»»æŒã£ã¦å‹•ã‘ã€‚",
    ],
    6: [
        "ã“ã‚Œä»¥ä¸Šã¯ç„¡ç†ã‚²ãƒ¼ã€‚",
        "å¼•ãéš›ã‚’è¦‹æ¥µã‚ã‚ã€‚",
        "æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ã€‚",
        "åŸ·ç€ã¯æ¯’ã€‚",
    ],
}

# å¦ã‚°ãƒ«ãƒ¼ãƒ—ã«å¿œã˜ãŸè¿½åŠ ãƒ•ãƒ¬ãƒ¼ã‚º
GROUP_SNS_ADDITIONS = {
    "ç™ºå±•ç³»": "ãƒãƒ£ãƒ³ã‚¹ã¯ä»Šã€é€ƒã™ãªã€‚",
    "å®‰å®šç³»": "ç¾çŠ¶ç¶­æŒãŒæ­£è§£ã€‚ç„¡ç†ã™ã‚“ãªã€‚",
    "å›°é›£ç³»": "ã—ã‚“ã©ã„ã‘ã©è€ãˆã‚ã€‚ãƒˆãƒ³ãƒãƒ«ã¯çµ‚ã‚ã‚‹ã€‚",
    "å¤‰é©ç³»": "å¤‰ã‚ã‚‹ã‹æ¶ˆãˆã‚‹ã‹ã€äºŒæŠã€‚",
    "åœæ»ç³»": "å¾…ã¦ã€‚å‹•ããªã€‚æ™‚ãŒæ¥ã‚‹ã¾ã§ã€‚",
    "ãƒãƒ©ãƒ³ã‚¹ç³»": "ãƒãƒ©ãƒ³ã‚¹å–ã‚Œã€‚æ¥µç«¯ã¯NGã€‚",
}

# ç‰¹å®šã®çˆ»è¾ã«å¯¾ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ SNSè§£èª¬
CUSTOM_SNS_PHRASES = {
    # ä¹¾ç‚ºå¤©ï¼ˆå¦1ï¼‰
    "1_1": "ğŸ‰ æ‰èƒ½ã‚ã£ã¦ã‚‚ä»Šã˜ã‚ƒãªã„ã€‚æ½œã‚Œã€‚æ™‚ãŒæ¥ã‚‹ã¾ã§æº–å‚™ã—ã‚ã€‚",
    "1_2": "ğŸŒ¾ ã‚„ã£ã¨èªã‚ã‚‰ã‚Œå§‹ã‚ãŸã€‚ã§ã‚‚ã¾ã æœ¬ç•ªã˜ã‚ƒãªã„ã€‚å®Ÿç¸¾ç©ã‚ã€‚",
    "1_3": "ğŸ’ª ã²ãŸã™ã‚‰åŠªåŠ›ã€‚ä¼‘ã‚€ãªã€‚ä»Šã®é ‘å¼µã‚ŠãŒæœªæ¥ã‚’ä½œã‚‹ã€‚",
    "1_4": "ğŸŒŠ é£›ã¶ã‹æ²ˆã‚€ã‹ã€‚æ±ºæ–­ã®æ™‚ã€‚è¿·ã†ãªã‚‰æ­¢ã¾ã‚Œã€‚",
    "1_5": "ğŸš€ æœ€å¼·ãƒ¢ãƒ¼ãƒ‰çªå…¥ã€‚ä»Šã“ãå…¨åŠ›ã§é£›ã¹ã€‚",
    "1_6": "âš ï¸ ã‚¤ã‚­ã‚Šã™ãæ³¨æ„ã€‚èª¿å­ä¹—ã‚‹ã¨è½ã¡ã‚‹ã€‚è¬™è™šã•å¿˜ã‚Œã‚‹ãªã€‚",
    
    # å¤ç‚ºåœ°ï¼ˆå¦2ï¼‰
    "2_1": "â„ï¸ å°ã•ãªå…†å€™ã‚’è¦‹é€ƒã™ãªã€‚éœœã‚’è¸ã‚“ã ã‚‰æ°·ãŒæ¥ã‚‹ã€‚",
    "2_2": "ğŸ’ ã‚·ãƒ³ãƒ—ãƒ«ã«ã€çœŸã£ç›´ãã«ã€‚ãã‚ŒãŒæœ€å¼·ã®æˆ¦ç•¥ã€‚",
    "2_3": "ğŸ¤« æ‰èƒ½ã¯éš ã›ã€‚è¦‹ã›ã³ã‚‰ã‹ã™ãªã€‚æ™‚ã‚’å¾…ã¦ã€‚",
    "2_4": "ğŸ¤ æ²ˆé»™ã¯é‡‘ã€‚ä½™è¨ˆãªã“ã¨è¨€ã†ãªã€‚",
    "2_5": "ğŸ‘‘ æ§ãˆã‚ãŒå‰ã€‚é»’å­ã§ã„ã„ã€‚ãã‚ŒãŒå‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚",
    "2_6": "âš”ï¸ äº‰ã„ã®äºˆæ„Ÿã€‚ã§ã‚‚ä»Šã¯å¼•ããŒå‹ã¡ã€‚",
    
    # æ°´é›·å±¯ï¼ˆå¦3ï¼‰
    "3_1": "ğŸª¨ å‹•ããªã€‚çŸ³ã«ãªã‚Œã€‚ä»Šã¯è€ãˆã‚‹æ™‚ã€‚",
    "3_2": "ğŸ”„ é€²ã‚“ã§ã¯æˆ»ã‚Šã€æˆ»ã£ã¦ã¯é€²ã‚€ã€‚æ··ä¹±ã—ã¦ã¦ã‚‚æ­£å¸¸ã€‚",
    "3_3": "ğŸ¦Œ ã‚¬ã‚¤ãƒ‰ãªã—ã§æ£®ã«å…¥ã‚‹ãªã€‚æº–å‚™ä¸è¶³ã§å‹•ãã¨è¿·å­ã€‚",
    "3_4": "ğŸ åŠ©ã‘ã‚’æ±‚ã‚ã‚ã€‚ä¸€äººã§çªæ’ƒã™ã‚‹ãªã€‚",
    "3_5": "ğŸ’§ å°‘ã—ãšã¤ã§ã„ã„ã€‚ç„¦ã£ã¦å…¨éƒ¨ã‚„ã‚ã†ã¨ã™ã‚‹ãªã€‚",
    "3_6": "ğŸ˜­ è¾›ã™ããƒ¯ãƒ­ã‚¿â€¦ã€‚ã§ã‚‚ã€å¤œæ˜ã‘å‰ãŒä¸€ç•ªæš—ã„ã€‚",
    
    # å±±æ°´è’™ï¼ˆå¦4ï¼‰
    "4_1": "ğŸ“š ã¾ãšå­¦ã¹ã€‚çŸ¥ã‚‰ãªã„ã“ã¨ã‚’èªã‚ã‚ã€‚",
    "4_2": "ğŸ¤— åˆå¿ƒè€…ã«å„ªã—ãã—ã‚ã€‚æ˜”ã®è‡ªåˆ†ã‚’æ€ã„å‡ºã›ã€‚",
    "4_3": "ğŸš« è¦‹ãŸç›®ã«é¨™ã•ã‚Œã‚‹ãªã€‚æœ¬è³ªã‚’è¦‹æŠœã‘ã€‚",
    "4_4": "ğŸ˜µ åˆ†ã‹ã‚‰ãªã™ãã¦è¾›ã„ã€‚ã§ã‚‚ãã‚ŒãŒæˆé•·ç—›ã€‚",
    "4_5": "ğŸ‘¶ ç´ ç›´ã•ãŒæ­¦å™¨ã€‚çŸ¥ã£ãŸã‹ã¶ã‚Šã¯NGã€‚",
    "4_6": "ğŸ‘Š ç”˜ã‚„ã‹ã—ã¯æ™‚ã«æ¯’ã€‚å³ã—ã•ã‚‚æ„›ã€‚",
    
    # æ°´å¤©éœ€ï¼ˆå¦5ï¼‰
    "5_1": "ğŸ•ï¸ å®‰å…¨åœã§å¾…æ©Ÿã€‚ç„¦ã‚‰ãšæº–å‚™ã€‚",
    "5_2": "ğŸ–ï¸ ã‚‚ã†å°‘ã—å¾…ã¦ã€‚ã¾ã å‹•ããªã€‚",
    "5_3": "ğŸ¥¾ æ³¥ã«ãƒãƒã£ãŸã€‚ã§ã‚‚è«¦ã‚ã‚‹ãªã€æŠœã‘å‡ºã›ã‚‹ã€‚",
    "5_4": "ğŸ©¸ ãƒ¤ãƒã„çŠ¶æ³ã€‚ã§ã‚‚è½ã¡ç€ã‘ã€‚ç”Ÿãå»¶ã³ã‚ã€‚",
    "5_5": "ğŸº å¾…ã£ãŸç”²æ–ã‚ã£ãŸï¼ã”è¤’ç¾ã‚¿ã‚¤ãƒ ã€‚",
    "5_6": "ğŸ•³ï¸ äºˆæƒ³å¤–ã®å±•é–‹ã€‚ã§ã‚‚ãƒãƒ£ãƒ³ã‚¹ã‹ã‚‚ã€‚",
    
    # å¤©æ°´è¨Ÿï¼ˆå¦6ï¼‰
    "6_1": "ğŸ›‘ äº‰ã„ã‚’é•·å¼•ã‹ã›ã‚‹ãªã€‚æ—©ã‚ã«æ‰‹ã‚’æ‰“ã¦ã€‚",
    "6_2": "ğŸ³ï¸ å‹ã¦ãªã„æˆ¦ã„ã‚‚ã‚ã‚‹ã€‚é€€å´ã¯æ¥ã˜ã‚ƒãªã„ã€‚",
    "6_3": "ğŸ“œ æ˜”ã®å®Ÿç¸¾ã‚’ä¿¡ã˜ã‚ã€‚ãã‚ŒãŒä»Šã®æ­¦å™¨ã€‚",
    "6_4": "ğŸ¤ èª°ã‹ã®è¨€ã†ã“ã¨èã‘ã€‚è‡ªåˆ†ã ã‘ã˜ã‚ƒè§£æ±ºã—ãªã„ã€‚",
    "6_5": "âš–ï¸ æ­£ã—ã„ã“ã¨ã¯é€šã‚‹ã€‚ä¿¡å¿µã‚’æŒã¦ã€‚",
    "6_6": "ğŸ–ï¸ è©•ä¾¡ã•ã‚Œã‚‹ã€‚ã§ã‚‚èª¿å­ä¹—ã‚‹ãªã€‚",
    
    # åç‚ºæ°´ï¼ˆå¦29ï¼‰
    "29_1": "ğŸŒŠ æ·±ã¿ã«ãƒãƒã£ãŸã€‚ç„¦ã‚‹ãªã€è½ã¡ç€ã‘ã€‚",
    "29_2": "âš ï¸ å±é™ºã ã‚‰ã‘ã€‚å°ã•ãªå‹ã¡ã‚’ç©ã‚ã€‚",
    "29_3": "ğŸ”„ ã©ã£ã¡è¡Œã£ã¦ã‚‚åœ°ç„ã€‚ã§ã‚‚æ­¢ã¾ã‚‹ãªã€‚",
    "29_4": "ğŸ¶ ã‚·ãƒ³ãƒ—ãƒ«ã«è¡Œã‘ã€‚ä½™è¨ˆãªã“ã¨ã™ã‚‹ãªã€‚",
    "29_5": "ğŸ“‰ ã¾ã åº•ã˜ã‚ƒãªã„ã€‚ã§ã‚‚å…‰ã¯è¦‹ãˆã¦ã‚‹ã€‚",
    "29_6": "ğŸ”— ç¸›ã‚‰ã‚Œã¦ã‚‹ã€‚ã§ã‚‚è«¦ã‚ãŸã‚‰çµ‚ã‚ã‚Šã€‚",
    
    # é›¢ç‚ºç«ï¼ˆå¦30ï¼‰
    "30_1": "ğŸ‘£ ç„¦ã£ã¦å‹•ããªã€‚ä¸€æ­©ãšã¤ä¸å¯§ã«ã€‚",
    "30_2": "ğŸŒŸ ãƒãƒ©ãƒ³ã‚¹å–ã‚Œã¦ã‚‹ã€‚ã“ã®èª¿å­ã§ã„ã‘ã€‚",
    "30_3": "ğŸŒ… æ „å…‰ã¯æ°¸é ã˜ã‚ƒãªã„ã€‚æ¬¡ã‚’è€ƒãˆã‚ã€‚",
    "30_4": "ğŸ’¥ çªç„¶ã®å¤‰åŒ–ã€‚å¯¾å¿œã—ã‚ã€‚",
    "30_5": "ğŸ˜¢ è¾›ãã¦ã‚‚æ¶™æ‹­ã„ã¦å‰ã¸ã€‚",
    "30_6": "âš”ï¸ æ‚ªã‚’æ–­ã¦ã€‚æ±ºæ–­ã®æ™‚ã€‚",
}


def generate_sns_phrase(hexagram_id: int, line_position: int, classic: str, modern: str, hexagram_name: str, group: str) -> str:
    """SNSé¢¨ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ç”Ÿæˆ"""
    
    # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ã‚ºãŒã‚ã‚Œã°ä½¿ç”¨
    key = f"{hexagram_id}_{line_position}"
    if key in CUSTOM_SNS_PHRASES:
        return CUSTOM_SNS_PHRASES[key]
    
    # ãªã‘ã‚Œã°è‡ªå‹•ç”Ÿæˆ
    base = STAGE_SNS_TEMPLATES.get(line_position, ["ä»Šã‚’ç”Ÿãã‚ã€‚"])[0]
    group_add = GROUP_SNS_ADDITIONS.get(group, "")
    
    # modernãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«SNSé¢¨ã«å¤‰æ›
    modern_short = modern[:20] if len(modern) > 20 else modern
    
    return f"ğŸ’¡ {modern_short}ã€‚{base} {group_add}"


def update_yao_master():
    """yao_master.jsonã«sns_styleã‚’è¿½åŠ """
    with open(YAO_MASTER, "r", encoding="utf-8") as f:
        yao_master = json.load(f)
    
    # yao_recommendations.jsonã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å–å¾—
    with open(YAO_RECOMMENDATIONS, "r", encoding="utf-8") as f:
        recs_data = json.load(f)
    
    recs_by_id = {}
    for rec in recs_data.get("recommendations", []):
        yao_id = rec.get("yao_id", "")
        if yao_id:
            recs_by_id[yao_id] = rec
    
    updated_count = 0
    
    for hex_id_str, hex_data in yao_master.items():
        hex_id = int(hex_id_str)
        hex_name = hex_data.get("name", "")
        
        for line_str, yao_data in hex_data.get("yao", {}).items():
            line = int(line_str)
            classic = yao_data.get("classic", "")
            modern = yao_data.get("modern", "")
            
            # ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å–å¾—
            yao_id = f"{hex_id:02d}_{line}"
            rec = recs_by_id.get(yao_id, {})
            group = rec.get("hexagram_group", "ãƒãƒ©ãƒ³ã‚¹ç³»")
            
            # SNSé¢¨ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ç”Ÿæˆ
            sns_phrase = generate_sns_phrase(hex_id, line, classic, modern, hex_name, group)
            yao_data["sns_style"] = sns_phrase
            updated_count += 1
    
    # ä¿å­˜
    with open(YAO_MASTER, "w", encoding="utf-8") as f:
        json.dump(yao_master, f, ensure_ascii=False, indent=2)
    
    print(f"âœ… yao_master.json ã‚’æ›´æ–°: {updated_count}ä»¶ã®sns_styleã‚’è¿½åŠ ")
    return yao_master


def update_yao_recommendations(yao_master: dict):
    """yao_recommendations.jsonã«ã‚‚sns_styleã‚’è¿½åŠ """
    with open(YAO_RECOMMENDATIONS, "r", encoding="utf-8") as f:
        recs_data = json.load(f)
    
    updated_count = 0
    
    for rec in recs_data.get("recommendations", []):
        hex_id = rec.get("hexagram_id")
        line = rec.get("line_position")
        
        if hex_id and line:
            yao_data = yao_master.get(str(hex_id), {}).get("yao", {}).get(str(line), {})
            sns_style = yao_data.get("sns_style", "")
            if sns_style:
                rec["sns_style"] = sns_style
                updated_count += 1
    
    # ä¿å­˜
    with open(YAO_RECOMMENDATIONS, "w", encoding="utf-8") as f:
        json.dump(recs_data, f, ensure_ascii=False, indent=2)
    
    print(f"âœ… yao_recommendations.json ã‚’æ›´æ–°: {updated_count}ä»¶ã®sns_styleã‚’è¿½åŠ ")


def main():
    print("=== 384çˆ»ã«SNSé¢¨è§£èª¬ã‚’è¿½åŠ  ===\n")
    
    print("1. yao_master.json ã‚’æ›´æ–°...")
    yao_master = update_yao_master()
    
    print("\n2. yao_recommendations.json ã‚’æ›´æ–°...")
    update_yao_recommendations(yao_master)
    
    print("\n=== ã‚µãƒ³ãƒ—ãƒ«å‡ºåŠ› ===")
    # ã„ãã¤ã‹ã‚µãƒ³ãƒ—ãƒ«ã‚’è¡¨ç¤º
    samples = [
        ("ä¹¾ç‚ºå¤©", 1, 1),
        ("å¤ç‚ºåœ°", 2, 3),
        ("æ°´é›·å±¯", 3, 6),
        ("åç‚ºæ°´", 29, 3),
    ]
    
    for name, hex_id, line in samples:
        yao_data = yao_master.get(str(hex_id), {}).get("yao", {}).get(str(line), {})
        print(f"\nã€{name} ç¬¬{line}çˆ»ã€‘")
        print(f"  å¤å…¸: {yao_data.get('classic', '')}")
        print(f"  ç¾ä»£: {yao_data.get('modern', '')}")
        print(f"  SNS: {yao_data.get('sns_style', '')}")
    
    print("\nâœ… å®Œäº†ï¼")


if __name__ == "__main__":
    main()
