# 六十四卦マッピング実装計画 v3（最終版）

## 目的の明確化

**目的**: 事例を易経フレームで整理し、傾向把握のための索引として使用する
**目的外**: 統計的因果推論、予測モデル構築

> Codex指摘: 「索引・物語化をしたいなら、outcomeとの統計連関を主要成果に据えるのをやめ、専門家評価を主要指標にする」

---

## v3の設計方針

### 方針1: 8卦完全網羅
- trigger辞書を8種類に拡張（乾を追加）
- action辞書を8種類に統一
- → 8×8=64通りを保証

### 方針2: 単純化
- リスト（複数trigger/action）を廃止 → **primaryのみ**を収集
- time_positionをイベント単位ではなくケース単位で維持（単純化優先）

### 方針3: アウトカムリーク対策
- story_summaryから**結果記述を除去したテキスト**でLLM抽出
- 「成功」「失敗」「回復」等の結果語をマスク

### 方針4: 評価指標の修正
- 分布偏りを指標から削除
- κは単一カテゴリ（primary_trigger, primary_action, time_position）で計算
- **適合度レビュー**（専門家が「この卦の割当は妥当か」を評価）を追加

---

## Phase 0: 決定表（完全版）

### trigger類型辞書（8種類）
| ID | label | 下卦 |
|----|-------|------|
| T_EXPANSION | 積極拡大 | 乾 |
| T_STAGNATION | 停滞・受容 | 坤 |
| T_EXT_SHOCK | 外部衝撃 | 震 |
| T_GRADUAL_CHANGE | 漸進的変化 | 巽 |
| T_DIFFICULTY | 困難・試練 | 坎 |
| T_CLARITY | 機会・明確化 | 離 |
| T_STOP | 行き詰まり・停止 | 艮 |
| T_INTERACTION | 交流・協調 | 兌 |

### action類型辞書（8種類）
| ID | label | 上卦 |
|----|-------|------|
| A_PUSH | 積極推進 | 乾 |
| A_ACCEPT | 受容・退却 | 坤 |
| A_MOVE | 動的変革 | 震 |
| A_ADAPT | 適応・浸透 | 巽 |
| A_ENDURE | 困難を耐える | 坎 |
| A_CLARIFY | 明確化・変容 | 離 |
| A_STOP | 集中・内省 | 艮 |
| A_CONNECT | 協調・提携 | 兌 |

### 上下卦→卦番号対応表（伏羲先天八卦序）
```
     乾  兌  離  震  巽  坎  艮  坤  （上卦）
乾    1  43  14  34  9   5  26  11
兌   10  58  38  54  61  60  41  19
離   13  49  30  55  37  63  22  36
震   25  17  21  51  42   3  27  24
巽   44  28  50  32  57  48  18  46
坎    6  47  64  40  59  29   4   7
艮   33  31  56  62  53  39  52  15
坤   12  45  35  16  20   8  23   2
（下卦）
```

### time_position → 爻位
| time_position | 爻位 | 説明 |
|---------------|------|------|
| T0_before | 1 | 変化前 |
| T1_early | 2 | 初期 |
| T2_peak | 3-4 | 転換点（scale大→4、小→3） |
| T3_late | 5 | 後期 |
| T4_after | 6 | 完了後 |

---

## Phase 1: 実装ステップ

### Step 1: 辞書構築（50件パイロット）
1. 50件をランダム抽出
2. **25件は二重ラベリング**
3. **primaryのみ**（trigger 1個、action 1個、time_position 1個）
4. κ≥0.7で合格

### Step 2: アウトカムマスク処理
```python
OUTCOME_WORDS = ['成功', '失敗', '回復', 'V字', '崩壊', '破綻', '達成', ...]
def mask_outcome(text):
    for word in OUTCOME_WORDS:
        text = text.replace(word, '[MASKED]')
    return text
```

### Step 3: LLM抽出（500件）
1. **マスク済みテキスト**をLLMに入力
2. 8選択肢から選ぶ形式（trigger/action各8種）
3. 人手50件との一致率計算

### Step 4: 全件マッピング
1. 決定表に基づき機械的に卦番号・爻を付与
2. 64卦の分布を確認（偏りは「データの性質」として記録、修正しない）

### Step 5: 適合度レビュー
1. 各卦から10件ずつサンプリング
2. 「この事例にこの卦は妥当か？」を5段階評価
3. 平均≥3.5で合格

---

## 成功指標（v3）

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| κ（primary_trigger） | ≥0.7 | 25件二重ラベリング |
| κ（primary_action） | ≥0.7 | 同上 |
| κ（time_position） | ≥0.6 | 同上（やや緩め） |
| LLM一致率 | ≥70% | 人手50件との比較 |
| 適合度レビュー | ≥3.5/5.0 | 専門家評価 |

**削除した指標**:
- ~~分布偏り~~ → データの性質であり品質指標ではない
- ~~p値検定~~ → 統計的因果は目的外

---

## 工数見積（v3）

| Phase | 作業 | 見積時間 |
|-------|------|---------|
| 0 | スキーマ・決定表確定 | 2時間 |
| 1 | 50件ラベリング（25件×2） | 6時間 |
| 1b | κ計算・修正 | 2時間 |
| 2 | マスク処理実装 | 2時間 |
| 3 | LLM抽出500件 | 3時間 |
| 4 | 全件マッピング | 2時間 |
| 5 | 適合度レビュー | 4時間 |
| **合計** | | **21時間** |

---

## v2→v3の主要変更

1. ✅ **8卦完全網羅**: trigger/action各8種類に統一
2. ✅ **卦番号対応表**: 伏羲先天八卦序で64卦を明示
3. ✅ **リスト廃止**: primaryのみ収集（単純化）
4. ✅ **アウトカムマスク**: 結果語を除去してからLLM抽出
5. ✅ **分布偏り削除**: 品質指標から除外
6. ✅ **適合度レビュー追加**: 専門家評価を成功指標に

---

## 出力イメージ

```json
{
  "case_id": "CORP_JP_001",
  "target_name": "日立製作所",
  "primary_trigger": "T_EXT_SHOCK",
  "primary_action": "A_ACCEPT",
  "time_position": "T3_late",
  "scale": "company",
  "hexagram": {
    "number": 24,
    "name": "地雷復",
    "upper_trigram": "坤",
    "lower_trigram": "震",
    "yao": 5
  },
  "outcome": "Success",
  "mapping_version": "v3.0"
}
```

---

## 使い方

```python
# 卦別の傾向を見る
df.groupby('hexagram.number')['outcome'].value_counts()

# 「地雷復」の事例を探す
df[df['hexagram.name'] == '地雷復']

# 震（外部衝撃）がトリガーの事例
df[df['primary_trigger'] == 'T_EXT_SHOCK']
```

傾向分析の「索引」として使用し、個別事例の参照や類似事例の検索に活用する。
