# HaQei診断 質問UX設計 v4

## 変更履歴
- v3 → v4: Codex批評（2026-01-13）の指摘を反映
  - Phase 1を2問→5問に変更
  - max方式→確率分布方式
  - 信頼度をエントロピーで数学的定義
  - agency/timeframeの概念混同を修正

---

## 設計原則（v3から継承＋修正）

1. **内部軸は維持** - Q1〜Q5の分類ロジックは有効
2. **行動指標への翻訳** - 抽象概念を具体的行動・状況で測定
3. **混合状態の数値保持** - ~~max方式~~ → 確率分布で表現
4. **設問バンク方式** - 動的生成ではなく事前設計の設問から出題
5. **説明可能性** - 「なぜこの結果か」を**寄与度**で明示
6. **Phase 1は5問固定** - 各軸最低1問の入力を保証

---

## 軸の再定義（概念混同の修正）

### 修正前（v3）の問題点
| 軸 | v3設計 | 問題 |
|----|--------|------|
| agency | コントロール感 + 行動開始度 | 異なる構成概念の混同 |
| timeframe | 発生時期 + 締切圧 | 異なる構成概念の混同 |

### 修正後（v4）
| 軸 | 定義 | 測定する単一概念 |
|----|------|------------------|
| changeNature | 変化の性質 | 拡大/収縮/維持/転換の傾向 |
| agency | 主体性 | コントロール感（自分で変えられる度合い） |
| timeframe | 時間軸 | 変化の発生時期 |
| relationship | 関係性 | 影響範囲（誰に影響するか） |
| emotionalTone | 感情基調 | 今感じている感情の分布 |

※「行動開始度」「締切圧」は測定しない（概念の純度を優先）

---

## 設問バンク設計（v4）

### Q1: changeNature（変化の性質）

**測定方式**: 4つの傾向それぞれを5段階で評価（4件法も検討）

| ID | 設問文 | 測定対象 |
|----|--------|----------|
| CN1 | 今、新しい役割・ポジション・責任を引き受けようとしていますか？ | 拡大 |
| CN2 | 今の仕事量や責任を減らしたい、手放したいと感じていますか？ | 収縮 |
| CN3 | 今の状態を安定させる・守ることが最優先ですか？ | 維持 |
| CN4 | 業界・職種・働き方そのものを変えることを考えていますか？ | 転換 |

**Phase 1使用**: CN1-CN4を1画面で同時提示（各5段階）

### Q2: agency（主体性）

**測定方式**: コントロール感のみを5段階で評価

| ID | 設問文 |
|----|--------|
| AG1 | 今起きている（または起きそうな）変化について、自分でどの程度コントロールできると感じますか？ |

**回答形式**: 5段階（1=全くできない 〜 5=完全にできる）

**Phase 1使用**: AG1のみ

### Q3: timeframe（時間軸）

**測定方式**: 発生時期のみを選択

| ID | 設問文 | 回答形式 |
|----|--------|----------|
| TF1 | この変化はいつ頃起きる（または起こす）予定ですか？ | 選択式 |

**選択肢**:
- 1ヶ月以内
- 3ヶ月以内
- 半年以内
- 1年以内
- 1年以上先
- わからない

**Phase 1使用**: TF1のみ

### Q4: relationship（関係性）

**測定方式**: 影響範囲を複数選択

| ID | 設問文 |
|----|--------|
| RL1 | この変化は主に誰に影響しますか？（複数選択可） |

**選択肢**:
- ☐ 自分自身
- ☐ 家族
- ☐ 同僚・チーム
- ☐ 組織全体
- ☐ 顧客・取引先
- ☐ 業界・社会

**Phase 1使用**: RL1のみ

### Q5: emotionalTone（感情基調）

**測定方式**: 4感情それぞれの強度を5段階評価

| ID | 設問文 |
|----|--------|
| ET1 | 今の状況について、以下の感情をどの程度感じていますか？ |

**サブ項目**:
- ワクワク・期待感: 5段階
- 慎重さ・用心深さ: 5段階
- 不安・心配: 5段階
- 楽観・なんとかなる感: 5段階

**Phase 1使用**: ET1（4感情すべて）

---

## スコアリング方式（v4）

### 原則: 確率分布で混合状態を保持

**v3（廃止）**:
```
changeNature: "拡大"  // max採用で単一ラベル
```

**v4（採用）**:
```typescript
interface AxisDistribution {
  values: { [key: string]: number };  // 確率分布（合計1.0）
  confidence: number;                  // 確信度（0-1）
}

// 例
changeNature: {
  values: { 拡大: 0.45, 維持: 0.30, 転換: 0.20, 収縮: 0.05 },
  confidence: 0.62
}
```

### スコア計算アルゴリズム

#### changeNature（4カテゴリ）
```typescript
function calculateChangeNature(cn1: number, cn2: number, cn3: number, cn4: number): AxisDistribution {
  const total = cn1 + cn2 + cn3 + cn4;
  const dist = {
    拡大: cn1 / total,
    収縮: cn2 / total,
    維持: cn3 / total,
    転換: cn4 / total
  };
  return {
    values: dist,
    confidence: calculateConfidence(Object.values(dist))
  };
}
```

#### agency（3カテゴリ）
```typescript
function calculateAgency(ag1: number): AxisDistribution {
  // 5段階を3カテゴリの確率分布に変換
  // 1-2: 待つ, 3: 受け止める, 4-5: 自ら動く
  const dist = {
    "自ら動く": ag1 >= 4 ? (ag1 - 3) / 2 : 0,
    "受け止める": Math.max(0, 1 - Math.abs(ag1 - 3) / 2),
    "待つ": ag1 <= 2 ? (3 - ag1) / 2 : 0
  };
  // 正規化
  const total = Object.values(dist).reduce((a, b) => a + b, 0);
  const normalized = Object.fromEntries(
    Object.entries(dist).map(([k, v]) => [k, v / total])
  );
  return {
    values: normalized,
    confidence: calculateConfidence(Object.values(normalized))
  };
}
```

### 確信度（confidence）の数学的定義

```typescript
function calculateConfidence(probabilities: number[]): number {
  // エントロピーベースの確信度
  // confidence = 1 - H(p) / H_max
  // H_max = log2(n) where n = number of categories

  const n = probabilities.length;
  const maxEntropy = Math.log2(n);

  let entropy = 0;
  for (const p of probabilities) {
    if (p > 0) {
      entropy -= p * Math.log2(p);
    }
  }

  return 1 - (entropy / maxEntropy);
}

// 例:
// [1, 0, 0, 0] → confidence = 1.0（完全に1つに集中）
// [0.25, 0.25, 0.25, 0.25] → confidence = 0.0（完全に均等）
// [0.6, 0.2, 0.1, 0.1] → confidence ≈ 0.42
```

---

## 診断フロー（v4）

### Phase 1: 必須5問（全軸カバー）

```
画面1: changeNature (CN1-CN4同時表示)
  「今のあなたの状況について、それぞれどの程度当てはまりますか？」

  □ 新しいことを始める・広げる段階     [1][2][3][4][5]
  □ 手放す・整理する段階               [1][2][3][4][5]
  □ 今の状態を守る・安定させる段階     [1][2][3][4][5]
  □ 方向転換・大きく変える段階         [1][2][3][4][5]

画面2: agency (AG1)
  「この変化について、自分でどの程度コントロールできると感じますか？」
  全くできない [1][2][3][4][5] 完全にできる

画面3: timeframe (TF1)
  「この変化はいつ頃起きる予定ですか？」
  ○ 1ヶ月以内  ○ 3ヶ月以内  ○ 半年以内
  ○ 1年以内    ○ 1年以上先  ○ わからない

画面4: relationship (RL1)
  「この変化は主に誰に影響しますか？（複数選択可）」
  ☐ 自分自身  ☐ 家族  ☐ 同僚・チーム
  ☐ 組織全体  ☐ 顧客・取引先  ☐ 業界・社会

画面5: emotionalTone (ET1)
  「今、以下の感情をどの程度感じていますか？」
  ワクワク・期待感     [1][2][3][4][5]
  慎重さ・用心深さ     [1][2][3][4][5]
  不安・心配           [1][2][3][4][5]
  楽観・なんとかなる感 [1][2][3][4][5]
```

### Phase 2: 追加質問（オプション）

**条件**: いずれかの軸で confidence < 0.5 の場合

追加設問バンクから選択:
- changeNature低確信 → CN5「具体的に何が変わりそうですか？」（自由記述）
- emotionalTone低確信 → ET2「最も強い感情はどれですか？」（強制選択）

### Phase 3: 候補提示

5軸の分布から易経64卦 × 6爻 = 384パターンへのマッチングスコアを計算

```typescript
interface CandidateResult {
  hexagram: number;      // 1-64
  yao: number;           // 1-6
  matchScore: number;    // 0-1
  matchReasons: string[]; // 「なぜこの結果か」の根拠
}

// Top-5候補を提示
```

---

## 「なぜこの結果か」の表示（v4）

### v3（廃止）: 回答の言い換え
```
【判定理由】
・拡大傾向（新しいことを始める段階を選択）
```

### v4（採用）: 寄与度の明示
```
【判定理由】
あなたの回答と「乾為天 初九」のマッチ度: 78%

主な寄与要因:
1. 変化の性質: 拡大傾向 (45%) が乾の「創造・拡張」と一致 (+22pt)
2. 主体性: 高いコントロール感 (4/5) が初九の「潜龍」の能動性と一致 (+18pt)
3. 時間軸: 3ヶ月以内が初九の「まだ動くな」と若干ミスマッチ (-5pt)
4. 感情: 期待感 (5/5) が乾の前向きさと一致 (+15pt)

※ 次点候補との差: 12pt（坤為地 初六: 66%）
```

---

## KPI設計（v4）

### 測定指標（修正版）

| 指標 | 計測方法 | 備考 |
|------|----------|------|
| 完了率 | 診断開始→結果表示 | Phase 1完了率も別計測 |
| 自己納得度 | 結果画面で5段階評価 | 「この結果は当てはまりますか？」 |
| **状況同一群での再テスト一致率** | 「前回と状況は同じ」申告者のみ | 60%目標は撤廃、参考値として計測 |
| 各軸の確信度分布 | 全ユーザーの confidence 平均・分散 | 低すぎる軸は設問改善の必要 |
| 説明文読了率 | 「判定理由」セクションの展開率 | 占い卒業層の信頼指標 |
| 離脱ポイント | どの画面で離脱したか | UI改善の指標 |

### A/Bテスト設計（交絡対策）

**問題**: 質問数が人によって違うとKPI比較が交絡

**対策**:
1. **Phase 1完了率**: 全員5問固定なので公平に比較可能
2. **Phase 2到達率**: 「追加質問が出た割合」を別計測
3. **層別分析**: Phase 2なし群 / あり群で分けて納得度を比較

---

## 中点偏り対策（v4）

### 採用する対策

1. **アンカー文言の強化**
   - 「1=全くない」「5=まさにそう」を明示
   - 各段階の意味を初回のみツールチップ表示

2. **逆方向項目の追加**（設問バンク拡張時）
   - CN1の逆: 「今は新しいことを始める時期ではないと感じる」
   - 逆転項目で回答の一貫性を検証

3. **4件法の検討**（将来オプション）
   - 中立を排除する場合のA/Bテスト計画を別途策定

---

## 実装計画（v4）

### Phase A: コアロジック（2日）
- `api/src/question-bank-v4.ts` - 設問データ構造
- `api/src/scoring-v4.ts` - 確率分布方式スコアリング
- `api/src/confidence.ts` - エントロピーベース確信度計算

### Phase B: マッチングロジック（2日）
- `api/src/hexagram-matcher.ts` - 5軸分布→64卦マッチング
- `api/src/explanation-generator.ts` - 寄与度ベース説明生成

### Phase C: UI更新（1.5日）
- `lp/index.html` - 5問フロー、確率分布表示
- 判定理由の展開式UI

### Phase D: KPI計測（1日）
- ログスキーマ設計
- 自己納得度入力UI
- 状況同一申告UI

### Phase E: テスト・検証（1.5日）
- 単体テスト（スコアリング、確信度計算）
- 統合テスト（全フロー）
- エッジケース検証（同点、混合状態）

**合計**: 8日（v3の4日見積りは楽観的すぎた）

---

## 付録: v3→v4 変更対応表

| 項目 | v3 | v4 |
|------|----|----|
| Phase 1質問数 | 2問 | 5問（各軸1問） |
| スコアリング | max採用 | 確率分布 |
| 信頼度定義 | なし | エントロピーベース |
| agency測定 | AG1+AG2平均 | AG1のみ |
| timeframe測定 | TF1+TF2 | TF1のみ |
| 説明表示 | 回答の言い換え | 寄与度の明示 |
| KPI | 再テスト一致率>60% | 状況同一群での参考値 |

---

*作成日: 2026-01-13*
*LLMディベート（v3批評）結果に基づく再設計*
