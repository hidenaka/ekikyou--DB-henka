# HaQei診断システム実装計画

## 背景

LLM Debate (Claude + Codex) の結果、以下が明確になった：

1. **10問で384爻への「正確な分類」は不可能**
   - 数学的に: 2^10 = 1024パターン vs 384クラス = 弁別力2.7倍のみ
   - 意味論的に: 易の卦は「正解ラベル」ではなく「解釈枠組み」

2. **設計の転換が必要**
   - 旧: 分類問題（10問 → 単一の卦/爻を出力）
   - 新: 検索・洞察生成問題（10問 → Top-k候補 → ユーザー選択 → 事例検索）

## 新設計アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザーフロー                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  [Phase 1] 初期絞り込み（5問・固定）                      │
│      │                                                  │
│      ▼                                                  │
│  [Phase 2] 適応型質問（0〜5問・確信度<70%時）              │
│      │                                                  │
│      ▼                                                  │
│  [候補提示] Top-5卦 + 確信度 + 状況説明                   │
│      │                                                  │
│      ▼                                                  │
│  [Phase 3] ユーザー選択 → 爻レベル深掘り                  │
│      │                                                  │
│      ▼                                                  │
│  [Phase 4] 事例提示                                      │
│      ├── 無料: 件数 + 概要 + 「続きで得られるもの」明示   │
│      └── 有料: 詳細事例3件 + Claude分析                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Phase 1: 初期絞り込み質問（5問）

| # | 質問軸 | 選択肢 | 対応する分類軸 |
|---|--------|--------|--------------|
| 1 | 変化の性質 | 拡大する/縮小する/現状維持/方向転換 | 八卦の動静 |
| 2 | 主体性 | 自ら動く/受け止める/待つ | 乾坤震巽の関係 |
| 3 | 時間軸 | 今すぐ/数ヶ月/1年以上 | 爻位の初期〜終末 |
| 4 | 関係性 | 個人の問題/組織内/対外関係 | 卦の内卦・外卦 |
| 5 | 感情基調 | 前向き/慎重/不安/楽観 | 吉凶の傾向 |

## Phase 2: 適応型質問

Phase 1の回答から確信度を計算し、70%未満の場合のみ追加質問を生成。

**確信度計算ロジック:**
```
confidence = max(候補卦のスコア) / sum(上位5卦のスコア)
```

**追加質問の生成:**
- 上位2候補の弁別に特化した質問を動的生成
- 例: 「困難に対して、突破を試みますか？それとも回避策を探しますか？」

## Phase 3: ユーザー選択

**表示方法（卦名は見せない）:**
```
あなたの状況に近いものを選んでください:

□ A: 新しいことを始めようとしている。エネルギーはあるが、
      まだ形になっていない。小さく試すのが吉。

□ B: 困難な状況にあるが、乗り越えられる力がある。
      焦らず一歩ずつ進むことで道が開ける。

□ C: 決断を迫られている。古いものを手放し、
      新しい方向に舵を切るタイミング。

□ D: 順調に進んでいるが、油断すると足元をすくわれる。
      謙虚さを保つことが重要。

□ E: 停滞している。今は動くべきではなく、
      力を蓄えて時機を待つべき。
```

**爻レベル深掘り:**
選択後、さらに「状況の段階」を確認:
- 1爻: 始まったばかり、準備段階
- 2爻: 動き出した、初期の展開
- 3爻: 困難や試練に直面
- 4爻: 転換点、重要な決断
- 5爻: 成熟期、成果が出る
- 6爻: 終末期、次への移行

## Phase 4: 事例提示

### 無料版
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
あなたの状況: [卦名] - [爻位の説明]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

類似事例: 47件

【代表的なパターン】
・キャリア転換: 23件（48.9%）
・事業立ち上げ: 12件（25.5%）
・組織変革: 12件（25.5%）

【無料で見られる情報】
✓ 全体的な傾向と注意点
✓ 類似事例の件数と分布
✓ この状況での一般的な成功パターン

【有料版で見られる情報】（980円）
→ 具体的な類似事例3件の詳細分析
→ あなたの状況に基づいた90日行動計画
→ 失敗パターンとその回避策
→ 次の質問（状況が変化したときの対応）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 有料版
- 詳細事例3件（entity_name, 状況, 結果, 教訓）
- Claude APIによる深層分析
- 90日行動計画
- 失敗パターンと回避策

## 技術実装

### バックエンド（Cloudflare Workers + D1）

```
POST /diagnose/phase1
Body: { answers: [1, 2, 1, 0, 3] }
Response: {
  candidates: [
    { hexagram: 3, confidence: 0.42, description: "..." },
    { hexagram: 39, confidence: 0.28, description: "..." },
    ...
  ],
  needsAdditionalQuestions: true,
  additionalQuestions: [...]
}

POST /diagnose/phase2
Body: { phase1Answers: [...], phase2Answers: [...] }
Response: {
  candidates: [...],  // 更新された候補
  needsAdditionalQuestions: false
}

POST /diagnose/select
Body: { selectedCandidate: 3 }
Response: {
  yaoOptions: [
    { yao: 1, description: "始まったばかり..." },
    ...
  ]
}

POST /diagnose/preview  (無料)
Body: { hexagram: 3, yao: 2 }
Response: {
  summary: "...",
  caseCount: 47,
  distribution: {...},
  previewContent: "...",
  paidContentPreview: ["90日計画", "失敗パターン", ...]
}

POST /diagnose/full  (有料・認証必要)
Body: { hexagram: 3, yao: 2, licenseKey: "..." }
Response: {
  detailedCases: [...],
  actionPlan: "...",
  failurePatterns: [...],
  nextSteps: [...]
}
```

### フロントエンド（LP）

- Step 1: Phase 1質問（5問）
- Step 2: Phase 2質問（0〜5問）
- Step 3: 候補選択画面
- Step 4: 爻選択画面
- Step 5: 結果画面（無料/有料分岐）

## 検証指標

| 指標 | 測定方法 | 目標値 |
|------|----------|--------|
| 関連度 | 「この事例は参考になる」率 | 60%以上 |
| 納得度 | 診断結果の5段階評価 | 平均3.5以上 |
| 再現性 | 同一ユーザー再診断の候補一致率 | 70%以上 |
| CV率 | 無料→有料への転換率 | 5%以上 |

## 実装優先順位

1. **Phase 1**: 質問→候補生成ロジック
2. **Phase 3/4**: 候補選択→事例検索
3. **LP統合**: フロントエンド実装
4. **Phase 2**: 適応型質問（後回し可）
5. **有料版**: Claude API統合

---
*作成日: 2026-01-13*
*LLM Debate結果に基づく設計転換*
